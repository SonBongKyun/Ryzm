<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ryzm Terminal ? AI Crypto Intelligence</title>
  <meta name="description"
    content="Ryzm Terminal: AI-powered cryptocurrency trading dashboard with real-time analytics and professional tools" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>" type="image/svg+xml">
  <link rel="icon" href="data:," sizes="any">

  <!-- Open Graph / SNS Preview -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Ryzm - AI Powered Crypto Intelligence" />
  <meta property="og:description" content="AI Council이 분석한 실시간 비트코인 매매 전략 & 온체인 데이터." />
  <meta property="og:image" content="/static/og-ryzm.png" />
  <meta property="og:url" content="https://ryzm.io/app" />
  <meta property="og:site_name" content="Ryzm Terminal" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Ryzm - AI Powered Crypto Intelligence" />
  <meta name="twitter:description" content="AI Council이 분석한 실시간 비트코인 매매 전략 & 온체인 데이터." />
  <meta name="twitter:image" content="/static/og-ryzm.png" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap"
    rel="stylesheet" />

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" integrity="sha384-ZZ1pncU3bQe8y31yfZdMFdSpttDoPmOZg2wguVK9almUodir1PghgT0eY7Mrty8H" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <!-- App Styles -->
  <link rel="stylesheet" href="/static/styles.css?v=7.8" />
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0D0D0F" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <!-- JS Error Collector — sends browser errors to server log -->
  <script>
  (function(){
    var _errs = [];
    window.onerror = function(msg, src, line, col, err) {
      var e = {msg:msg, src:src, line:line, col:col, stack:err&&err.stack?err.stack.slice(0,500):''};
      _errs.push(e);
      try { navigator.sendBeacon('/api/client-error', JSON.stringify(e)); } catch(x){}
    };
    window.addEventListener('unhandledrejection', function(ev) {
      var e = {msg:'UnhandledRejection: '+(ev.reason&&ev.reason.message||String(ev.reason)), src:'promise', line:0, col:0, stack:ev.reason&&ev.reason.stack?ev.reason.stack.slice(0,500):''};
      _errs.push(e);
      try { navigator.sendBeacon('/api/client-error', JSON.stringify(e)); } catch(x){}
    });
    window._jsErrors = _errs;
  })();
  </script>
  <!-- Force nuke all old SW + caches once, then reload cleanly -->
  <script>
  (function(){
    var TARGET_VER = '7.0';
    if(localStorage.getItem('ryzm_sw_nuke') === TARGET_VER) return;
    var promises = [];
    // 1) Unregister ALL service workers
    if('serviceWorker' in navigator){
      promises.push(
        navigator.serviceWorker.getRegistrations().then(function(regs){
          regs.forEach(function(r){ r.unregister(); });
        })
      );
    }
    // 2) Delete ALL caches
    if('caches' in window){
      promises.push(
        caches.keys().then(function(keys){
          keys.forEach(function(k){ caches.delete(k); });
        })
      );
    }
    // 3) Clear stale panel order from localStorage (forces fresh layout)
    Object.keys(localStorage).forEach(function(k){
      if(k.startsWith('ryzm_panel_order')) localStorage.removeItem(k);
    });
    // 4) Also reset server-side layout
    Promise.all(promises).then(function(){
      localStorage.setItem('ryzm_sw_nuke', TARGET_VER);
      // Reset server layout to empty
      fetch('/api/layout', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({panels: {}})
      }).catch(function(){});
      location.reload(true);
    });
  })();
  </script>
</head>

<body>
  <!-- Dashboard Boot Overlay -->
  <div id="dash-boot" class="dash-boot-overlay">
    <div class="dash-boot-inner">
      <div class="dash-boot-logo">RYZM<span class="dash-boot-cursor">_</span></div>
      <div class="dash-boot-text">Terminal v7.7 Ready</div>
    </div>
  </div>

  <canvas id="matrix-bg"></canvas>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       HEADER
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <header class="header">
    <!-- Logo -->
    <a href="/about" class="logo" style="text-decoration:none;color:inherit;">
      <span class="logo-dot"></span>
      Ryzm_OS
      <span class="pro-badge">PRO</span>
    </a>

    <!-- BGM Player (v2) -->
    <div class="bgm-player" id="bgm-player">
      <!-- Playback controls -->
      <div class="bgm-controls">
        <button id="bgm-prev" title="Previous" class="bgm-btn bgm-btn-sm">
          <i data-lucide="skip-back" style="width:11px;height:11px;"></i>
        </button>
        <button id="bgm-play" title="Play / Pause" class="bgm-btn bgm-btn-play">
          <i data-lucide="play" style="width:14px;height:14px;"></i>
        </button>
        <button id="bgm-skip" title="Next" class="bgm-btn bgm-btn-sm">
          <i data-lucide="skip-forward" style="width:11px;height:11px;"></i>
        </button>
      </div>
      <!-- Track info + progress -->
      <div class="bgm-info">
        <div class="bgm-info-row">
          <span id="bgm-track-name" class="bgm-track-name">Stopped</span>
          <span id="bgm-time" class="bgm-time">0:00 / 0:00</span>
        </div>
        <div class="bgm-progress-track" id="bgm-progress-track">
          <div class="bgm-progress-fill" id="bgm-progress-fill"></div>
        </div>
      </div>
      <!-- Volume -->
      <div class="bgm-vol-group">
        <button id="bgm-mute" class="bgm-btn bgm-btn-sm" title="Mute" aria-label="Toggle mute">
          <i data-lucide="volume-2" style="width:12px;height:12px;"></i>
        </button>
        <input type="range" id="bgm-volume" class="volume-slider" min="0" max="100" value="60" />
      </div>
      <!-- Playlist toggle -->
      <button id="bgm-list-toggle" class="bgm-btn bgm-btn-sm" title="Playlist">
        <i data-lucide="list-music" style="width:12px;height:12px;"></i>
      </button>
      <!-- Playlist dropdown -->
      <div class="bgm-playlist" id="bgm-playlist" style="display:none;"></div>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="theme-toggle" class="theme-toggle" title="Toggle Dark Mode" aria-label="Toggle dark mode">
      <i data-lucide="moon" style="width:16px;height:16px;"></i>
    </button>

    <!-- Language Toggle (i18n) -->
    <button id="lang-toggle" class="lang-toggle" title="?쒓뎅??English" aria-label="Switch language">
      <span id="lang-label">EN</span>
    </button>

    <!-- Auth Button -->
    <button id="btn-auth" class="auth-btn" title="Login / Register" onclick="toggleAuthModal()">
      <i data-lucide="user" style="width:14px;height:14px;"></i>
      <span id="auth-label">Login</span>
    </button>
    <span id="header-plan-badge" class="header-plan-badge" style="display:none;font-size:0.6rem;padding:2px 6px;border-radius:3px;cursor:pointer;" onclick="openUpgradeModal('general')">FREE</span>
    <button id="header-upgrade-tab" class="header-upgrade-tab" style="display:none;" onclick="openUpgradeModal('general')">
      <i data-lucide="zap" style="width:11px;height:11px;"></i>
      <span>Upgrade</span>
    </button>
    <span id="header-usage-counter" class="usage-counter-badge" style="display:none;" title="Today's AI usage (Council / Validator / Chat)">
      AI <span class="usage-val" id="usage-council">0</span><span class="usage-sep">/</span><span class="usage-max" id="usage-council-max">10</span>
    </span>

    <!-- Daily Report Button -->
    <button id="btn-daily-report" class="daily-report-btn" title="Get Daily Briefing" onclick="openDailyReportModal()">
      <i data-lucide="bell-ring" style="width:13px;height:13px;"></i>
      <span>Daily Report</span>
    </button>

    <!-- Help / FAQ Button -->
    <button id="btn-help-faq" class="daily-report-btn" title="Help & FAQ" onclick="openHelpModal()" style="border-color:var(--text-secondary);color:var(--text-secondary);">
      <i data-lucide="help-circle" style="width:13px;height:13px;"></i>
      <span>Help</span>
    </button>

    <!-- FX Rate -->
    <div class="header-fx" id="header-fx">
      <span class="fx-label">USD/KRW</span>
      <span class="fx-value" id="fx-usdkrw">??</span>
      <span class="fx-change" id="fx-usdkrw-chg"></span>
      <span class="fx-divider">|</span>
      <span class="fx-label">USD/JPY</span>
      <span class="fx-value" id="fx-usdjpy">??</span>
      <span class="fx-change" id="fx-usdjpy-chg"></span>
    </div>

    <!-- Dual Clock -->
    <!-- Market Status -->
    <div class="market-status" id="market-status">
      <span class="market-dot" id="mkt-crypto">CRYPTO</span>
      <span class="market-dot" id="mkt-nyse">NYSE</span>
      <span class="market-dot" id="mkt-forex">FOREX</span>
    </div>

    <div class="dual-clock">
      <div class="clock-item">
        <div class="clock-label">Seoul 쨌 KST</div>
        <div class="clock-time" id="clock-kst">--:--:--</div>
      </div>
      <div class="clock-divider"></div>
      <div class="clock-item">
        <div class="clock-label">New York 쨌 EST</div>
        <div class="clock-time" id="clock-est">--:--:--</div>
      </div>
    </div>
  </header>

  <!-- Macro Ticker (New) -->
  <div class="macro-ticker-container">
    <div class="ticker-wrapper">
      <div id="macro-ticker" class="ticker-content">
        <span class="ticker-loading">INITIALIZING MARKET DATA FEED...</span>
      </div>
    </div>
  </div>

  <!-- Vibe Bar HUD -->
  <div id="vibe-bar" class="vibe-bar">
    <div class="vibe-label" data-i18n-text="market_vibe">MARKET VIBE:</div>
    <div id="vibe-status" class="vibe-status">LOADING...</div>
    <div id="regime-badge" class="regime-badge">--</div>
    <div class="vibe-divider"></div>
    <div id="vibe-message" class="vibe-marquee">Ryzm System Initializing...</div>
  </div>

  <!-- Section Navigation Bar -->
  <nav class="section-nav" id="section-nav">
    <div class="section-nav-track">
      <a class="snav-item active" data-target="risk-gauge-panel" title="Systemic Risk Gauge"><i data-lucide="shield-alert"></i><span data-i18n-text="snav_risk">Risk</span></a>
      <a class="snav-item" data-target="fg-panel" title="Fear & Greed"><i data-lucide="thermometer"></i><span data-i18n-text="snav_fg">F&G</span></a>
      <a class="snav-item" data-target="mtf-panel-nav" title="Multi-TF"><i data-lucide="layers"></i><span data-i18n-text="snav_mtf">MTF</span></a>
      <span class="snav-sep"></span>
      <a class="snav-item" data-target="council-section" title="Neural Council"><i data-lucide="cpu"></i><span data-i18n-text="snav_council">Council</span></a>
      <a class="snav-item" data-target="chart-panel" title="Chart"><i data-lucide="bar-chart-2"></i><span data-i18n-text="snav_chart">Chart</span></a>
      <a class="snav-item" data-target="validator-panel" title="Trade Validator"><i data-lucide="shield-check"></i><span data-i18n-text="snav_validator">Validator</span></a>
      <a class="snav-item" data-target="council-history-panel" title="AI Tracker"><i data-lucide="brain-circuit"></i><span data-i18n-text="snav_tracker">Tracker</span></a>
      <a class="snav-item" data-target="heatmap-section" title="Heatmap"><i data-lucide="grid-3x3"></i><span data-i18n-text="snav_heatmap">Heatmap</span></a>
      <span class="snav-sep"></span>
      <a class="snav-item" data-target="prices-section" title="Realtime Prices"><i data-lucide="trending-up"></i><span data-i18n-text="snav_prices">Prices</span></a>
      <a class="snav-item" data-target="ls-section" title="Long/Short"><i data-lucide="scale"></i><span data-i18n-text="snav_ls">L/S</span></a>
      <a class="snav-item" data-target="scanner-section" title="Alpha Scanner"><i data-lucide="radar"></i><span data-i18n-text="snav_scanner">Scanner</span></a>
      <a class="snav-item" data-target="whale-section" title="Whale Alert"><i data-lucide="anchor"></i><span data-i18n-text="snav_whale">Whale</span></a>
      <a class="snav-item" data-target="onchain-section" title="On-Chain"><i data-lucide="link"></i><span data-i18n-text="snav_onchain">On-Chain</span></a>
      <a class="snav-item" data-target="news-section" title="Live Wire"><i data-lucide="rss"></i><span data-i18n-text="snav_news">News</span></a>
      <span class="snav-sep"></span>
      <a class="snav-item" data-target="portfolio-section" title="Portfolio"><i data-lucide="wallet"></i><span>Portfolio</span></a>
      <a class="snav-item" data-target="accuracy-section" title="Accuracy"><i data-lucide="target"></i><span>Accuracy</span></a>
    </div>
  </nav>

  <!-- Quick Action Toolbar -->
  <div class="quick-actions">
    <div class="tooltip-wrapper">
      <button class="quick-btn" id="btn-refresh-all" title="Refresh All Data">
        <i data-lucide="refresh-cw" style="width:18px;height:18px;"></i>
      </button>
      <span class="tooltip" data-i18n-text="refresh_all">Refresh All</span>
    </div>
    <div class="tooltip-wrapper">
      <button class="quick-btn" id="btn-fullscreen" title="Toggle Fullscreen">
        <i data-lucide="maximize-2" style="width:18px;height:18px;"></i>
      </button>
      <span class="tooltip" data-i18n-text="fullscreen">Fullscreen</span>
    </div>
    <div class="tooltip-wrapper">
      <button class="quick-btn" id="btn-notifications" title="Notification Settings">
        <i data-lucide="bell" style="width:18px;height:18px;"></i>
      </button>
      <span class="tooltip" data-i18n-text="notifications">Notifications</span>
    </div>
  </div>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       MAIN 3-COLUMN GRID
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <main class="main-grid" id="main-grid">

    <div class="panel" id="panel-left" data-panel-id="left">
      <!-- Systemic Risk Gauge v2.0 -->
      <div class="glass-panel risk-gauge-panel" id="risk-gauge-panel" style="position: relative; overflow: hidden;">
        <div class="panel-title" data-i18n="risk_gauge">
          <i data-lucide="shield-alert"></i> Systemic Risk Gauge
          <span class="info-tooltip" data-tip="종합 시장 위험도 지표. 높을수록(+) 과열, 낮을수록(-) 공포 구간.">(?)</span>
          <button class="rg-alert-btn" id="rg-alert-btn" title="Set Alert Threshold"><i data-lucide="bell" style="width:12px;height:12px;"></i></button>
        </div>
        <!-- Alert threshold config (hidden by default) -->
        <div class="rg-alert-config hidden" id="rg-alert-config">
          <label>Alert Threshold</label>
          <input type="range" id="rg-threshold" min="-100" max="100" step="5" value="-50">
          <span class="rg-threshold-val" id="rg-threshold-val">-50</span>
          <button class="rg-alert-save" id="rg-alert-save">SET</button>
        </div>
        <div class="risk-gauge-body">
          <!-- 270째 Arc Gauge SVG -->
          <div class="gauge-container">
            <svg viewBox="0 0 200 200" class="gauge-svg">
              <defs>
                <linearGradient id="gaugeGrad270" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#dc2626"/>
                  <stop offset="30%" stop-color="#f97316"/>
                  <stop offset="50%" stop-color="#eab308"/>
                  <stop offset="75%" stop-color="#C9A96E"/>
                  <stop offset="100%" stop-color="#059669"/>
                </linearGradient>
                <linearGradient id="gaugeInner270" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stop-color="white" stop-opacity="0.4"/>
                  <stop offset="100%" stop-color="black" stop-opacity="0.12"/>
                </linearGradient>
                <filter id="gaugeGlow270" x="-20%" y="-20%" width="140%" height="140%">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
                  <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <filter id="needleGlow270" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur"/>
                  <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
                <radialGradient id="hubGrad270" cx="50%" cy="40%" r="50%">
                  <stop offset="0%" stop-color="#1e293b" stop-opacity="1"/>
                  <stop offset="100%" stop-color="#1e293b" stop-opacity="0.4"/>
                </radialGradient>
              </defs>
              <!-- Outer rim -->
              <path d="M 43.43 156.57 A 80 80 0 1 1 156.57 156.57" fill="none" stroke="var(--border-dim)" stroke-width="18" stroke-linecap="round" opacity="0.3"/>
              <!-- Background track -->
              <path d="M 43.43 156.57 A 80 80 0 1 1 156.57 156.57" fill="none" stroke="var(--border-dim)" stroke-width="14" stroke-linecap="round"/>
              <!-- Inner highlight -->
              <path d="M 45.5 154.5 A 77 77 0 1 1 154.5 154.5" fill="none" stroke="url(#gaugeInner270)" stroke-width="10" stroke-linecap="round" opacity="0.4"/>
              <!-- Gradient background arc -->
              <path d="M 43.43 156.57 A 80 80 0 1 1 156.57 156.57" fill="none" stroke="url(#gaugeGrad270)" stroke-width="12" stroke-linecap="round" opacity="0.2"/>
              <!-- Active arc (filled by JS) -->
              <path id="gauge-arc" d="M 43.43 156.57 A 80 80 0 1 1 156.57 156.57" fill="none" stroke="url(#gaugeGrad270)" stroke-width="12" stroke-linecap="round" stroke-dasharray="377" stroke-dashoffset="188" filter="url(#gaugeGlow270)" style="transition: stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1);"/>
              <!-- Tick marks (7 ticks for 270째) -->
              <g stroke="var(--text-muted)" stroke-width="1" opacity="0.35">
                <line x1="43" y1="157" x2="51" y2="151"/>
                <line x1="24" y1="100" x2="34" y2="100"/>
                <line x1="43" y1="43" x2="51" y2="49"/>
                <line x1="100" y1="20" x2="100" y2="30"/>
                <line x1="157" y1="43" x2="149" y2="49"/>
                <line x1="176" y1="100" x2="166" y2="100"/>
                <line x1="157" y1="157" x2="149" y2="151"/>
              </g>
              <!-- Zone labels -->
              <text x="30" y="145" fill="#dc2626" font-size="5.5" font-family="var(--font-head)" text-anchor="middle" opacity="0.7">CRIT</text>
              <text x="20" y="85" fill="#f97316" font-size="5.5" font-family="var(--font-head)" text-anchor="middle" opacity="0.7">HIGH</text>
              <text x="55" y="35" fill="#eab308" font-size="5.5" font-family="var(--font-head)" text-anchor="middle" opacity="0.6">ELEV</text>
              <text x="145" y="35" fill="#C9A96E" font-size="5.5" font-family="var(--font-head)" text-anchor="middle" opacity="0.6">MOD</text>
              <text x="180" y="85" fill="#059669" font-size="5.5" font-family="var(--font-head)" text-anchor="middle" opacity="0.7">LOW</text>
              <!-- Scale labels -->
              <text x="38" y="172" fill="var(--text-muted)" font-size="7" font-family="var(--font-mono)" text-anchor="middle">-100</text>
              <text x="100" y="14" fill="var(--text-muted)" font-size="7" font-family="var(--font-mono)" text-anchor="middle">0</text>
              <text x="162" y="172" fill="var(--text-muted)" font-size="7" font-family="var(--font-mono)" text-anchor="middle">+100</text>
              <!-- Needle -->
              <g id="gauge-needle" transform="rotate(0, 100, 100)" style="transition: transform 1.2s cubic-bezier(0.4,0,0.2,1);">
                <line x1="100" y1="100" x2="100" y2="28" stroke="#334155" stroke-width="3" stroke-linecap="round" opacity="0.2" transform="translate(1,1)"/>
                <line id="needle-line" x1="100" y1="100" x2="100" y2="26" stroke="#1e293b" stroke-width="2.5" stroke-linecap="round" filter="url(#needleGlow270)"/>
              </g>
              <!-- Center hub -->
              <circle cx="100" cy="100" r="9" fill="#1e293b" class="gauge-hub"/>
              <circle cx="98" cy="97" r="3.5" fill="white" opacity="0.3"/>
              <!-- Score & label inside SVG -->
              <text id="gauge-score-svg" x="100" y="130" text-anchor="middle" fill="#1e293b" font-size="18" font-family="var(--font-mono)" font-weight="900">0</text>
              <text id="gauge-label-svg" x="100" y="143" text-anchor="middle" fill="#1e293b" font-size="6.5" font-family="var(--font-head)" letter-spacing="1.5px">[LOADING]</text>
              <!-- Alert threshold line (hidden by default) -->
              <line id="gauge-threshold-line" x1="100" y1="100" x2="100" y2="30" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4 2" opacity="0" style="transition: opacity 0.3s;"/>
            </svg>
            <!-- AI Commentary -->
            <div class="rg-commentary" id="rg-commentary"></div>
            <!-- Delta indicator -->
            <div class="gauge-delta" id="risk-delta"></div>
          </div>

          <!-- Tabbed sections -->
          <div class="rg-tabs" id="rg-tabs">
            <button class="rg-tab active" data-rgtab="components"><i data-lucide="bar-chart-3" style="width:10px;height:10px;"></i> Comp</button>
            <button class="rg-tab" data-rgtab="radar"><i data-lucide="radar" style="width:10px;height:10px;"></i> Radar</button>
            <button class="rg-tab" data-rgtab="heatmap"><i data-lucide="grid-3x3" style="width:10px;height:10px;"></i> ? Map</button>
            <button class="rg-tab" data-rgtab="corr"><i data-lucide="link" style="width:10px;height:10px;"></i> Corr</button>
            <button class="rg-tab" data-rgtab="sim"><i data-lucide="sliders-horizontal" style="width:10px;height:10px;"></i> Sim</button>
          </div>

          <!-- Tab: Components with sparklines -->
          <div class="rg-tab-content active" id="rg-tab-components">
            <div class="risk-components-v2" id="risk-components">
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_sentiment">SENTIMENT</span><canvas class="rc-spark" id="rc-spark-fg" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-fg-bar"></div></div><span class="rc-value" id="rc-fg">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_volatility">VOLATILITY</span><canvas class="rc-spark" id="rc-spark-vix" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-vix-bar"></div></div><span class="rc-value" id="rc-vix">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_leverage">LEVERAGE</span><canvas class="rc-spark" id="rc-spark-ls" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-ls-bar"></div></div><span class="rc-value" id="rc-ls">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_funding">FUNDING</span><canvas class="rc-spark" id="rc-spark-fr" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-fr-bar"></div></div><span class="rc-value" id="rc-fr">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_kimchi">KIMCHI P.</span><canvas class="rc-spark" id="rc-spark-kp" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-kp-bar"></div></div><span class="rc-value" id="rc-kp">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_oi">OI</span><canvas class="rc-spark" id="rc-spark-oi" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-oi-bar"></div></div><span class="rc-value" id="rc-oi">??</span></div>
              <div class="rc-row"><span class="rc-label" data-i18n-text="rc_stablecoin">USDT DOM</span><canvas class="rc-spark" id="rc-spark-sc" width="40" height="16"></canvas><div class="rc-bar-track"><div class="rc-bar-fill" id="rc-sc-bar"></div></div><span class="rc-value" id="rc-sc">??</span></div>
            </div>
          </div>

          <!-- Tab: Radar Chart -->
          <div class="rg-tab-content" id="rg-tab-radar">
            <svg id="rg-radar-svg" viewBox="0 0 200 200" class="rg-radar-canvas"></svg>
          </div>

          <!-- Tab: Change Rate Heatmap -->
          <div class="rg-tab-content" id="rg-tab-heatmap">
            <table class="rg-heatmap-table" id="rg-heatmap-table">
              <thead><tr><th></th><th>1H</th><th>4H</th><th>24H</th></tr></thead>
              <tbody id="rg-heatmap-body"></tbody>
            </table>
          </div>

          <!-- Tab: Correlation Matrix -->
          <div class="rg-tab-content" id="rg-tab-corr">
            <div class="rg-corr-matrix" id="rg-corr-matrix">
              <div class="rg-corr-loading">Loading correlation data...</div>
            </div>
          </div>

          <!-- Tab: Scenario Simulator -->
          <div class="rg-tab-content" id="rg-tab-sim">
            <div class="rg-simulator" id="rg-simulator">
              <div class="rg-sim-row"><label>Fear/Greed</label><input type="range" class="rg-sim-slider" id="sim-fg" min="0" max="100" value="50"><span id="sim-fg-val">50</span></div>
              <div class="rg-sim-row"><label>VIX</label><input type="range" class="rg-sim-slider" id="sim-vix" min="10" max="80" value="20"><span id="sim-vix-val">20</span></div>
              <div class="rg-sim-row"><label>Long %</label><input type="range" class="rg-sim-slider" id="sim-ls" min="30" max="70" value="50"><span id="sim-ls-val">50</span></div>
              <div class="rg-sim-row"><label>Fund Rate</label><input type="range" class="rg-sim-slider" id="sim-fr" min="-0.1" max="0.1" step="0.005" value="0"><span id="sim-fr-val">0</span></div>
              <div class="rg-sim-row"><label>Kimchi %</label><input type="range" class="rg-sim-slider" id="sim-kp" min="-5" max="10" step="0.5" value="0"><span id="sim-kp-val">0</span></div>
              <div class="rg-sim-row"><label>OI (B$)</label><input type="range" class="rg-sim-slider" id="sim-oi" min="10" max="50" value="20"><span id="sim-oi-val">20</span></div>
              <div class="rg-sim-row"><label>USDT Dom%</label><input type="range" class="rg-sim-slider" id="sim-sc" min="2" max="12" step="0.5" value="5"><span id="sim-sc-val">5</span></div>
              <div class="rg-sim-result" id="rg-sim-result">
                <span class="rg-sim-score" id="rg-sim-score">0</span>
                <span class="rg-sim-label" id="rg-sim-label">MODERATE</span>
              </div>
            </div>
          </div>

          <div class="gauge-timestamp" id="gauge-timestamp"></div>
        </div>
        <!-- Risk History Chart + Zone Timeline + Price Overlay -->
        <div class="risk-history-chart" id="risk-history-section">
          <div class="risk-history-header">
            <span class="risk-history-title"><i data-lucide="trending-up" style="width:12px;height:12px;"></i> RISK INDEX (30D)</span>
            <span class="risk-history-range" id="risk-history-range">??</span>
            <button class="rg-overlay-btn" id="rg-price-overlay-btn" title="Toggle BTC Price Overlay"><i data-lucide="layers" style="width:11px;height:11px;"></i></button>
          </div>
          <canvas id="risk-history-canvas" width="320" height="100" style="width:100%;height:100px;cursor:crosshair;"></canvas>
          <div class="rg-chart-tooltip hidden" id="rg-chart-tooltip"></div>
          <div class="rg-zone-timeline" id="rg-zone-timeline"></div>
        </div>
      </div>

      <!-- Museum of Scars -->
      <div class="glass-panel" style="min-height: 140px; position: relative;">
        <div class="panel-title" data-i18n="museum_scars"><i data-lucide="skull"></i> Museum of Scars <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
        <div id="scars-feed" style="overflow-y:auto; max-height: 200px; font-size:0.72rem;">
          <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div><div class="skeleton skeleton-line short"></div></div>
        </div>
        </div>
      </div>

      <!-- Fear & Greed Index (Upgraded v2) -->
      <div class="glass-panel fg-chart-panel" id="fg-panel" style="min-height:200px;">
        <div class="panel-title" data-i18n="fg_chart"><i data-lucide="thermometer"></i> Fear & Greed Index <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <!-- Top: Gauge + Score -->
          <div class="fg-top-row">
            <div class="fg-gauge-wrap">
              <canvas id="fg-gauge-canvas" width="180" height="110"></canvas>
              <div class="fg-gauge-center">
                <span class="fg-score-big" id="fg-score-big">??</span>
                <span class="fg-label-big" id="fg-label-big">Loading...</span>
              </div>
            </div>
            <div class="fg-info-col">
              <div class="fg-emoji" id="fg-emoji">??</div>
              <div class="fg-delta" id="fg-delta">
                <span class="fg-delta-arrow" id="fg-delta-arrow"></span>
                <span class="fg-delta-val" id="fg-delta-val">--</span>
                <span class="fg-delta-label">vs yesterday</span>
              </div>
              <div class="fg-comment" id="fg-comment">Analyzing market sentiment...</div>
            </div>
          </div>
          <!-- Stats bar -->
          <div class="fg-stats-bar">
            <div class="fg-stat"><span class="fg-stat-label">7D avg</span><span class="fg-stat-val" id="fg-avg-7d">--</span></div>
            <div class="fg-stat"><span class="fg-stat-label">14D avg</span><span class="fg-stat-val" id="fg-avg-14d">--</span></div>
            <div class="fg-stat"><span class="fg-stat-label">30D avg</span><span class="fg-stat-val" id="fg-avg-30d">--</span></div>
            <div class="fg-stat"><span class="fg-stat-label">30D range</span><span class="fg-stat-val" id="fg-range-30d">--</span></div>
          </div>
          <!-- Period toggle + Chart -->
          <div class="fg-chart-header">
            <div class="fg-period-tabs">
              <button class="fg-period-btn active" data-period="7">7D</button>
              <button class="fg-period-btn" data-period="14">14D</button>
              <button class="fg-period-btn" data-period="30">30D</button>
            </div>
          </div>
          <canvas id="fg-canvas" width="320" height="100" style="width:100%;height:100px;"></canvas>
        </div>
      </div>

      <!-- Multi-Timeframe Analysis -->
      <div class="glass-panel mtf-panel" id="mtf-panel-nav" data-pro="true" style="min-height:160px;">
        <div class="panel-title" data-i18n="mtf_analysis"><i data-lucide="layers"></i> Multi-TF Analysis <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <div class="mtf-symbol" id="mtf-symbol">BTC/USDT</div>
          <table class="mtf-table" id="mtf-table">
            <thead>
              <tr><th>TF</th><th>RSI</th><th>EMA</th><th>Signal</th></tr>
            </thead>
            <tbody id="mtf-tbody">
              <tr><td colspan="4" style="text-align:center;color:var(--text-muted);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="glass-panel" data-pro="true" style="height: 120px; min-height:120px;">
        <div class="panel-title" data-i18n="kimchi_premium"><i data-lucide="flame"></i> Kimchi Premium</div>
        <div class="kp-gauge">
          <div class="kp-value" id="kp-value" style="font-size:1.5rem; font-family:var(--font-mono); color:var(--neon-green);">+3.42%
          </div>
          <div id="kp-status" style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">Arb Opportunity: LOW</div>
          <div style="font-size:0.6rem; color:var(--text-tertiary); margin-top:3px;">updated <span id="kp-updated">--:--</span></div>
        </div>
      </div>

      <!-- Economic Calendar -->
      <div class="glass-panel" style="height: 150px; min-height:150px;">
        <div class="panel-title" data-i18n="econ_calendar"><i data-lucide="calendar"></i> Economic Calendar <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
        <div id="calendar-feed" style="overflow-y:auto; max-height:105px; font-size:0.72rem;">
          <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div><div class="skeleton skeleton-line short"></div></div>
        </div>
        </div>
      </div>
    </div>

    <div class="center-panel" id="panel-center" data-panel-id="center">

      <div class="council-container" id="council-section">
        <!-- Auto Analysis Status Bar -->
        <div class="council-auto-bar" id="council-auto-bar">
          <div class="cab-left"><span class="cab-pulse"></span><span class="cab-label">AUTO ANALYSIS</span></div>
          <span class="cab-last" id="cab-last">Last: --</span>
          <span class="cab-sep">|</span>
          <span class="cab-next" id="cab-next">Next: --</span>
          <canvas class="cab-spark" id="cab-spark" width="72" height="18"></canvas>
        </div>
        <!-- Header + Consensus Gauge -->
        <div class="council-header-row">
          <div class="council-title-col">
            <span class="council-label">/// ANALYSIS_COUNCIL</span>
          </div>
          <div class="consensus-gauge" id="consensus-gauge">
            <svg viewBox="0 0 120 72" class="cg-svg">
              <defs>
                <linearGradient id="cg-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#dc2626"/><stop offset="40%" stop-color="#f97316"/>
                  <stop offset="60%" stop-color="#eab308"/><stop offset="100%" stop-color="#059669"/>
                </linearGradient>
              </defs>
              <path class="cg-track" d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="rgba(100,116,139,0.12)" stroke-width="7" stroke-linecap="round"/>
              <path class="cg-value" id="cg-value" d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="url(#cg-grad)" stroke-width="7" stroke-linecap="round" stroke-dasharray="0 157"/>
              <text x="60" y="46" text-anchor="middle" class="cg-score" id="cg-score">--</text>
              <text x="60" y="60" text-anchor="middle" class="cg-label" id="cg-label">SCORE</text>
            </svg>
          </div>
        </div>
        <!-- Hidden data holder for backward compat -->
        <span id="consensus-score" style="display:none;">SCORE: --</span>
        <!-- Edge Panel -->
        <div class="edge-panel" id="edge-panel" style="display:none;">
          <div class="ep-bias-row">
            <span class="ep-bias-lbl bull" id="ep-bull-ct">0 BULL</span>
            <div class="ep-bias-bar"><div class="ep-bull-fill" id="ep-bull-fill"></div><div class="ep-bear-fill" id="ep-bear-fill"></div></div>
            <span class="ep-bias-lbl bear" id="ep-bear-ct">0 BEAR</span>
          </div>
          <div class="ep-info-row">
            <div class="ep-agree-ring">
              <svg viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="none" stroke="rgba(100,116,139,0.12)" stroke-width="3"/><circle id="ep-agree-arc" cx="20" cy="20" r="16" fill="none" stroke="var(--neon-cyan)" stroke-width="3" stroke-dasharray="0 100.5" stroke-linecap="round" transform="rotate(-90 20 20)"/></svg>
              <span class="ep-agree-val" id="ep-agree-val">--%</span>
            </div>
            <span class="ep-badge pred" id="ep-pred">--</span>
            <span class="ep-badge conf" id="ep-conf">--</span>
            <span class="ep-edge-num" id="ep-edge-num">EDGE: --</span>
          </div>
        </div>
        <!-- Agent Cards -->
        <div class="agents-grid" id="agents-grid">
          <div class="agent-card">
            <div class="ac-top"><div class="ac-avatar sys"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><span class="ac-led"></span></div>
            <div class="ac-name">SYSTEM</div>
            <div class="ac-msg">Standby...</div>
          </div>
        </div>
        <!-- Narrative Radar Chart -->
        <div class="narrative-radar" id="narrative-radar" style="display:none;">
          <canvas id="radar-canvas" width="260" height="180"></canvas>
        </div>
      </div>

      <div class="glass-panel chart-container" id="chart-panel"
        style="height:calc(100vh - 180px); min-height:400px; max-height:700px; padding:0; border:1px solid var(--border-bright); overflow:hidden;">
        <!-- Symbol Tabs + Intervals -->
        <div class="chart-header">
          <div class="chart-tabs" id="chart-tabs">
            <button class="chart-tab active" data-binance="BTCUSDT" data-name="BTC/USDT"><span class="tab-label">BTC</span><span class="tab-price"></span></button>
            <button class="chart-tab" data-binance="ETHUSDT" data-name="ETH/USDT"><span class="tab-label">ETH</span><span class="tab-price"></span></button>
            <button class="chart-tab" data-binance="SOLUSDT" data-name="SOL/USDT"><span class="tab-label">SOL</span><span class="tab-price"></span></button>
            <button class="chart-tab" data-binance="XRPUSDT" data-name="XRP/USDT"><span class="tab-label">XRP</span><span class="tab-price"></span></button>
            <button class="chart-tab-add" id="chart-tab-add" title="Add Symbol">+</button>
          </div>
          <div class="chart-intervals" id="chart-intervals">
            <button class="interval-btn" data-interval="1m">1m</button>
            <button class="interval-btn" data-interval="5m">5m</button>
            <button class="interval-btn" data-interval="15m">15m</button>
            <button class="interval-btn active" data-interval="1H">1H</button>
            <button class="interval-btn" data-interval="4H">4H</button>
            <button class="interval-btn" data-interval="1D">1D</button>
            <button class="interval-btn" data-interval="1W">1W</button>
          </div>
        </div>
        <!-- Info Bar: Price / 24h Change / 24h Range / Volume -->
        <div class="chart-info-bar" id="chart-info-bar">
          <div class="cib-price" id="cib-price">&mdash;</div>
          <div class="cib-change" id="cib-change">&mdash;</div>
          <div class="cib-stat"><span class="cib-label">24h H</span><span class="cib-val" id="cib-high">&mdash;</span></div>
          <div class="cib-stat"><span class="cib-label">24h L</span><span class="cib-val" id="cib-low">&mdash;</span></div>
          <div class="cib-stat"><span class="cib-label">Vol</span><span class="cib-val" id="cib-vol">&mdash;</span></div>
          <div class="cib-range-wrap">
            <span class="cib-range-lo" id="cib-range-lo">&mdash;</span>
            <div class="cib-range-bar"><div class="cib-range-fill" id="cib-range-fill"></div><div class="cib-range-dot" id="cib-range-dot"></div></div>
            <span class="cib-range-hi" id="cib-range-hi">&mdash;</span>
          </div>
        </div>
        <!-- Chart Toolbar -->
        <div class="chart-toolbar" id="chart-toolbar">
          <!-- Chart Type -->
          <div class="toolbar-group">
            <button class="ctype-btn active" data-ctype="candle" title="Candlestick"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="4" width="6" height="16" rx="1"/><line x1="12" y1="1" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="23"/></svg></button>
            <button class="ctype-btn" data-ctype="line" title="Line"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,17 9,11 13,15 21,7"/></svg></button>
            <button class="ctype-btn" data-ctype="area" title="Area"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3,17 L9,11 L13,15 L21,7 L21,21 L3,21 Z" fill="currentColor" opacity="0.15"/><polyline points="3,17 9,11 13,15 21,7"/></svg></button>
          </div>
          <div class="toolbar-divider"></div>
          <!-- Indicators -->
          <div class="toolbar-group">
            <button class="ind-toggle active" data-ind="ema" title="EMA 7/25/99"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3,18 Q8,6 12,12 T21,6"/></svg> EMA</button>
            <button class="ind-toggle" data-ind="bb" title="Bollinger Bands (20,2)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="12" rx="9" ry="6"/></svg> BB</button>
            <button class="ind-toggle" data-ind="rsi" title="RSI (14)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="2,18 6,6 10,14 14,4 18,12 22,8"/></svg> RSI</button>
            <button class="ind-toggle" data-ind="macd" title="MACD (12,26,9)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="10" width="3" height="8"/><rect x="8" y="6" width="3" height="12"/><rect x="13" y="8" width="3" height="10"/><rect x="18" y="4" width="3" height="14"/></svg> MACD</button>
            <button class="ind-toggle active" data-ind="vol" title="Volume"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="14" width="4" height="6"/><rect x="8" y="8" width="4" height="12"/><rect x="14" y="11" width="4" height="9"/><rect x="20" y="5" width="4" height="15"/></svg> Vol</button>
            <button class="ind-toggle" data-ind="funding" title="Funding Rate"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12,7 v10 M9,10 h6 M9,14 h4"/></svg> Fund</button>
            <button class="ind-toggle" data-ind="liqmap" title="Liquidation Map"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12,2 L15,10 L22,12 L15,14 L12,22 L9,14 L2,12 L9,10 Z"/></svg> Liq</button>
            <button class="ind-toggle" data-ind="depth" title="Order Book Depth"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2,20 L8,16 L12,17 L18,10 L22,4"/><path d="M2,4 L6,8 L12,7 L16,14 L22,20"/></svg> Depth</button>
          </div>
          <div class="toolbar-divider"></div>
          <!-- Drawing Tools -->
          <div class="toolbar-group">
            <button class="draw-tool-btn" data-tool="hline" title="Horizontal Line"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="12" x2="22" y2="12"/></svg></button>
            <button class="draw-tool-btn" data-tool="trendline" title="Trend Line"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="20" x2="21" y2="4"/></svg></button>
            <button class="draw-tool-btn" data-tool="fib" title="Fibonacci"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="4" x2="22" y2="4"/><line x1="2" y1="10" x2="22" y2="10"/><line x1="2" y1="15" x2="22" y2="15"/><line x1="2" y1="20" x2="22" y2="20"/></svg></button>
            <button class="draw-tool-btn draw-clear" data-tool="clear" title="Clear Drawings"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6 L18,20a2,2 0 0 1-2,2H8a2,2 0 0 1-2-2L5,6"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
          </div>
          <div class="toolbar-divider"></div>
          <!-- Layout + Actions -->
          <div class="toolbar-group">
            <button class="layout-btn active" data-layout="1x1" title="Single Chart"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
            <button class="layout-btn" data-layout="2x2" title="4-Chart Grid"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></button>
          </div>
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <button class="toolbar-action-btn" id="btn-chart-signals" title="AI Signal Markers"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12,20 v-8"/><circle cx="12" cy="8" r="3"/><path d="M5,5 Q12,0 19,5"/><path d="M7,8 Q12,4 17,8"/></svg></button>
            <button class="toolbar-action-btn" id="btn-chart-journal" title="Journal on Chart"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4,4 h16a1,1 0 0 1 1,1v14a1,1 0 0 1-1,1H4a1,1 0 0 1-1-1V5a1,1 0 0 1 1-1z"/><line x1="8" y1="9" x2="16" y2="9"/><line x1="8" y1="13" x2="14" y2="13"/></svg></button>
            <button class="toolbar-action-btn" id="btn-chart-snapshot" title="Snapshot"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23,19 a2,2 0 0 1-2,2H3a2,2 0 0 1-2-2V8a2,2 0 0 1 2-2h4l2-3h6l2,3h4a2,2 0 0 1 2,2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button class="toolbar-action-btn" id="btn-chart-fullscreen" title="Fullscreen"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,3 21,3 21,9"/><polyline points="9,21 3,21 3,15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></button>
            <select class="comp-select" id="comp-select" title="Compare Symbol">
              <option value="">Compare</option>
              <option value="ETHUSDT">ETH</option>
              <option value="SOLUSDT">SOL</option>
              <option value="XRPUSDT">XRP</option>
              <option value="BTCUSDT">BTC</option>
              <option value="DOGEUSDT">DOGE</option>
              <option value="BNBUSDT">BNB</option>
            </select>
          </div>
        </div>
        <!-- OHLCV Legend -->
        <div class="ryzm-chart-legend" id="ryzm-chart-legend"></div>
        <!-- Chart Body (flex container) -->
        <div class="chart-body">
          <!-- Chart Layout Wrapper -->
          <div id="chart-layout-wrapper" class="chart-layout-1x1">
            <div id="ryzm-chart-container" style="height:100%; width:100%;"></div>
          </div>
          <!-- RSI Sub-chart Container -->
          <div id="ryzm-rsi-container" class="chart-sub"></div>
          <!-- Depth Sub-chart Container -->
          <div id="ryzm-depth-container" class="chart-sub"></div>
        </div>
        <!-- Symbol Search Popup (hidden) -->
        <div class="chart-symbol-search" id="chart-symbol-search" style="display:none;">
          <input type="text" class="css-input" id="css-input" placeholder="Search symbol... (e.g. DOGE)" autocomplete="off" />
          <div class="css-results" id="css-results"></div>
        </div>
      </div>

      <!-- Loading Steps -->
      <div class="council-steps" id="council-steps" style="display:none;">
        <div class="cs-step" data-step="1"><span class="cs-dot"></span><span class="cs-text">CONNECTING</span></div>
        <div class="cs-step" data-step="2"><span class="cs-dot"></span><span class="cs-text">ANALYZING</span></div>
        <div class="cs-step" data-step="3"><span class="cs-dot"></span><span class="cs-text">COMPARING</span></div>
        <div class="cs-step" data-step="4"><span class="cs-dot"></span><span class="cs-text">SYNTHESIZING</span></div>
      </div>

      <button class="ai-scan-btn" id="btn-council-start">
        <i data-lucide="zap"></i> <span data-i18n-text="execute_analysis">EXECUTE ANALYSIS PROTOCOL</span>
      </button>

      <div class="council-last-run" id="council-last-run" style="display:none;">
        <span id="clr-time"></span> &middot; <span id="clr-duration"></span>
      </div>

      <!-- Transparency Notice -->
      <div style="margin-top:8px;text-align:center;font-size:0.65rem;color:var(--text-dim);opacity:0.7;line-height:1.4;">
        One AI engine, multiple analysis lenses &middot; Not financial advice
      </div>
      <button id="btn-copy-report" class="ai-scan-btn secondary-btn"
        style="display:none; margin-top:10px; background:var(--bg-panel); border:1px solid var(--neon-magenta); color:var(--neon-magenta);">
        <i data-lucide="copy"></i> <span data-i18n-text="copy_report">COPY REPORT FOR X</span>
      </button>

      <!-- Strategic Narrative -->
      <div id="strategic-narrative" class="strategic-narrative" style="display:none;">
        <div class="sn-header" data-i18n-text="strategic_narrative">
          <i data-lucide="layers" style="width:14px;height:14px;"></i> STRATEGIC NARRATIVE
        </div>
        <div id="sn-layers"></div>
      </div>

      <button id="btn-snapshot" class="ai-scan-btn secondary-btn" style="margin-top:10px; background:#333; color:#fff;">
        <i data-lucide="camera"></i> <span data-i18n-text="export_snapshot">EXPORT SNAPSHOT</span>
      </button>

      <button id="btn-save-journal" class="ai-scan-btn secondary-btn"
        style="display:none; margin-top:10px; background:var(--bg-panel); border:1px solid var(--neon-green); color:var(--neon-green);">
        <i data-lucide="bookmark-plus"></i> SAVE TO JOURNAL
      </button>

      <!-- Trade Validator (P0-1) -->
      <div class="glass-panel validator-panel" id="validator-panel" style="margin-top:12px;">
        <div class="panel-title" data-i18n="trade_validator">
          <i data-lucide="shield-check"></i> Trade Validator
          <span class="val-credits" id="val-credits">?/? Free</span>
        </div>
        <div class="panel-body">
          <div class="validator-form">
            <input type="text" id="val-symbol" class="val-input" placeholder="Symbol (e.g. BTC)" maxlength="20" />
            <input type="number" id="val-price" class="val-input" placeholder="Entry Price ($)" step="0.01" min="0" />
            <select id="val-position" class="val-input">
              <option value="LONG">LONG</option>
              <option value="SHORT">SHORT</option>
            </select>
            <button id="btn-validate" class="validate-btn">
              <i data-lucide="zap"></i> <span data-i18n-text="validate_trade">VALIDATE TRADE</span>
            </button>
          </div>
          <div id="validator-result" class="validator-result" style="display:none;"></div>
        </div>
      </div>

      <!-- AI Council Prediction History -->
      <div class="glass-panel council-history-panel" id="council-history-panel" style="margin-top:12px;">
        <div class="panel-title" data-i18n="ai_tracker">
          <i data-lucide="brain-circuit"></i> AI Prediction Tracker
          <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i>
        </div>
        <div class="panel-body">
          <div class="ch-stats" id="ch-stats">
            <div class="ch-stat-box">
              <div class="ch-stat-value" id="ch-total">??</div>
              <div class="ch-stat-label">SESSIONS</div>
            </div>
            <div class="ch-stat-box ch-accuracy">
              <div class="ch-stat-value" id="ch-accuracy">??</div>
              <div class="ch-stat-label">HIT RATE</div>
            </div>
            <div class="ch-stat-box">
              <div class="ch-stat-value" id="ch-hits">??</div>
              <div class="ch-stat-label">HITS</div>
            </div>
          </div>
          <!-- Multi-Horizon Accuracy Breakdown -->
          <div class="ch-horizons" id="ch-horizons" style="display:flex;gap:4px;margin:6px 0;font-size:0.65rem;">
            <div class="ch-hz-pill" data-hz="15min"><span class="ch-hz-label">15m</span><span class="ch-hz-val" id="ch-hz-15">??</span></div>
            <div class="ch-hz-pill" data-hz="60min"><span class="ch-hz-label">1h</span><span class="ch-hz-val" id="ch-hz-60">??</span></div>
            <div class="ch-hz-pill" data-hz="240min"><span class="ch-hz-label">4h</span><span class="ch-hz-val" id="ch-hz-240">??</span></div>
            <div class="ch-hz-pill" data-hz="1440min"><span class="ch-hz-label">1d</span><span class="ch-hz-val" id="ch-hz-1440">??</span></div>
          </div>
          <div class="ch-chart" id="ch-chart">
            <canvas id="ch-canvas" width="400" height="80"></canvas>
          </div>
          <!-- Council Score vs BTC Overlay -->
          <div class="ch-overlay-section" id="ch-overlay-section">
            <div class="ch-overlay-header">
              <span class="ch-overlay-title"><i data-lucide="git-compare" style="width:12px;height:12px;"></i> SCORE vs BTC</span>
            </div>
            <canvas id="ch-overlay-canvas" width="400" height="100" style="width:100%;height:100px;"></canvas>
            <div class="ch-overlay-stats" id="ch-overlay-stats">
              <div class="ch-zone-stat bull">
                <span class="ch-zone-label">BULL ZONE (??0)</span>
                <span class="ch-zone-value" id="ch-bull-avg">??</span>
              </div>
              <div class="ch-zone-stat bear">
                <span class="ch-zone-label">BEAR ZONE (??0)</span>
                <span class="ch-zone-value" id="ch-bear-avg">??</span>
              </div>
            </div>
          </div>
          <!-- PR-5: Cumulative Return Curve -->
          <div class="ch-equity-section" id="ch-equity-section" style="margin-top:8px;">
            <div class="ch-overlay-header">
              <span class="ch-overlay-title"><i data-lucide="trending-up" style="width:12px;height:12px;"></i> CUMULATIVE RETURN</span>
            </div>
            <canvas id="ch-equity-canvas" width="400" height="80" style="width:100%;height:80px;"></canvas>
          </div>
          <!-- PR-5: Regime Performance Badges -->
          <div class="ch-regime-badges" id="ch-regime-badges" style="display:flex;gap:4px;flex-wrap:wrap;margin:6px 0;font-size:0.62rem;"></div>
          <!-- PR-5: CSV Export Button (Pro) -->
          <div style="text-align:right;margin-top:4px;">
            <button id="btn-export-csv" class="btn-export-csv" style="font-size:0.62rem;padding:2px 8px;border:1px solid var(--border-dim);background:transparent;color:var(--text-secondary);border-radius:4px;cursor:pointer;" title="Export CSV (Pro)">
              <i data-lucide="download" style="width:10px;height:10px;"></i> CSV
            </button>
          </div>
          <div class="ch-records" id="ch-records" style="max-height:120px; overflow-y:auto; font-size:0.7rem;">
            <div style="text-align:center; color:var(--text-muted); padding:10px;">Run Council to start tracking...</div>
          </div>
        </div>
      </div>

      <!-- Mini Heatmap -->
      <div class="glass-panel heatmap-panel" id="heatmap-section" style="margin-top:12px;">
        <div class="panel-title" style="justify-content:space-between;">
          <span data-i18n="market_heatmap"><i data-lucide="grid-3x3"></i> Market Heatmap</span>
          <div class="hm-period-toggle" id="hm-period-toggle">
            <button class="hm-period-btn active" data-period="24h">24H</button>
            <button class="hm-period-btn" data-period="7d">7D</button>
          </div>
        </div>
        <!-- BTC Dominance + Total Mcap -->
        <div class="hm-dominance-row" id="hm-dominance-row">
          <div class="hm-dom-item">
            <span class="hm-dom-label">BTC Dom</span>
            <div class="hm-dom-bar-wrap">
              <div class="hm-dom-bar-fill" id="hm-btc-dom-fill" style="width:0%"></div>
            </div>
            <span class="hm-dom-val" id="hm-btc-dom-val">?</span>
          </div>
          <div class="hm-dom-item">
            <span class="hm-dom-label" data-i18n="hm_total_mcap">Total MCap</span>
            <span class="hm-dom-val mono" id="hm-total-mcap">?</span>
          </div>
        </div>
        <!-- Top Gainers / Losers Bar -->
        <div class="hm-movers-row" id="hm-movers-row">
          <div class="hm-movers-col hm-gainers">
            <span class="hm-movers-label gain">▲ <span data-i18n="hm_top_gainers">Top Gainers</span></span>
            <div class="hm-movers-list" id="hm-gainers-list"></div>
          </div>
          <div class="hm-movers-col hm-losers">
            <span class="hm-movers-label loss">▼ <span data-i18n="hm_top_losers">Top Losers</span></span>
            <div class="hm-movers-list" id="hm-losers-list"></div>
          </div>
        </div>
        <!-- Treemap Grid -->
        <div id="heatmap-grid" class="heatmap-grid">
          <div style="text-align:center; padding:15px; color:var(--text-muted); font-size:0.75rem;" data-i18n="heatmap_loading">Loading heatmap...</div>
        </div>
        <!-- Tooltip (hidden) -->
        <div class="hm-tooltip" id="hm-tooltip"></div>
      </div>

      <!-- Liquidation Kill Zone -->
      <div class="glass-panel liq-panel" data-pro="true" style="margin-top:12px;">
        <div class="panel-title" data-i18n="liq_heatmap"><i data-lucide="target"></i> Liquidation Kill Zone <span class="info-tooltip" data-tip="대규모 청산이 집중된 가격대. 해당 구간 접근 시 급변동 가능.">(?)</span> <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <div id="liq-zones" style="min-height:80px;">
            <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div></div>
          </div>
        </div>
      </div>

      <!-- Correlation Matrix -->
      <div class="glass-panel corr-panel" data-pro="true" style="margin-top:12px;">
        <div class="panel-title" data-i18n="correlation_matrix"><i data-lucide="network"></i> Correlation Matrix (30D) <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <div id="corr-matrix" style="min-height:80px;">
            <div class="skeleton-loader"><div class="skeleton skeleton-block"></div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-right" data-panel-id="right">
      <!-- Real-time Price Panel (v5.6) -->
      <div class="glass-panel" id="prices-section" style="flex: 1;">
        <div class="panel-title" data-i18n="realtime_prices">
          <i data-lucide="trending-up"></i> Realtime Prices
          <span id="price-ws-status" class="price-ws-badge" title="WebSocket Status">
            <span class="price-ws-dot"></span><span class="price-ws-label">CONNECTING</span>
          </span>
          <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i>
        </div>
        <div class="panel-body">
          <!-- Summary Stats Marquee Ticker -->
          <div class="price-marquee-wrap">
            <div id="price-marquee" class="price-marquee">
              <div class="price-marquee-inner">
                <span class="pmq-item"><span class="pmq-label">BTC.D</span><span id="psb-btcd" class="pmq-val">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">24h Vol</span><span id="psb-vol" class="pmq-val">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">Gainers</span><span id="psb-gainers" class="pmq-val up">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">Losers</span><span id="psb-losers" class="pmq-val down">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">BTC</span><span id="psb-btc" class="pmq-val">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">ETH</span><span id="psb-eth" class="pmq-val">?</span></span>
                <span class="pmq-sep">│</span>
                <span class="pmq-item"><span class="pmq-label">SOL</span><span id="psb-sol" class="pmq-val">?</span></span>
              </div>
            </div>
          </div>
          <!-- Sort & Filter Toolbar -->
          <div class="price-toolbar">
            <div class="price-filter-group">
              <button class="price-filter-btn active" data-filter="all">ALL</button>
              <button class="price-filter-btn" data-filter="crypto"><i data-lucide="bitcoin" style="width:11px;height:11px;"></i> Crypto</button>
              <button class="price-filter-btn" data-filter="macro"><i data-lucide="landmark" style="width:11px;height:11px;"></i> Macro</button>
            </div>
            <div class="price-sort-group">
              <button class="price-sort-btn active" data-sort="default" title="Default order">
                <i data-lucide="list" style="width:12px;height:12px;"></i>
              </button>
              <button class="price-sort-btn" data-sort="change-desc" title="Top gainers">
                <i data-lucide="arrow-up-circle" style="width:12px;height:12px;"></i>
              </button>
              <button class="price-sort-btn" data-sort="change-asc" title="Top losers">
                <i data-lucide="arrow-down-circle" style="width:12px;height:12px;"></i>
              </button>
              <button class="price-sort-btn" data-sort="vol-desc" title="Highest volume">
                <i data-lucide="bar-chart-3" style="width:12px;height:12px;"></i>
              </button>
              <button id="price-theme-toggle" class="price-sort-btn" title="Glass / Dark mode">
                <i data-lucide="sun-moon" style="width:12px;height:12px;"></i>
              </button>
            </div>
          </div>
          <!-- Price Cards Container -->
          <div id="realtime-prices" class="price-panel" style="display:flex !important;flex-direction:column !important;flex-wrap:nowrap !important;overflow-y:auto;overflow-x:hidden;max-height:600px;width:100%;">
            <div class="skeleton-loader"><div class="skeleton skeleton-block"></div><div class="skeleton skeleton-block"></div><div class="skeleton skeleton-block"></div></div>
          </div>
          <!-- Hover Preview Card (hidden) -->
          <div id="price-hover-card" class="price-hover-card hidden">
            <div class="phc-header">
              <span class="phc-icon"></span>
              <span class="phc-symbol"></span>
              <span class="phc-source"></span>
            </div>
            <div class="phc-price-row">
              <span class="phc-price"></span>
              <span class="phc-change"></span>
            </div>
            <div class="phc-stats">
              <div class="phc-stat"><span class="phc-stat-label">24h High</span><span class="phc-stat-val" id="phc-high">?</span></div>
              <div class="phc-stat"><span class="phc-stat-label">24h Low</span><span class="phc-stat-val" id="phc-low">?</span></div>
              <div class="phc-stat"><span class="phc-stat-label">Volume</span><span class="phc-stat-val" id="phc-vol">?</span></div>
              <div class="phc-stat"><span class="phc-stat-label">Mkt Cap</span><span class="phc-stat-val" id="phc-mcap">?</span></div>
            </div>
            <div class="phc-chart">
              <canvas id="phc-canvas" width="220" height="60"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- L/S Ratio Panel (Upgraded) -->
      <div class="glass-panel ls-panel" id="ls-section" style="margin-bottom:15px;">
        <div class="panel-title" data-i18n="long_short"><i data-lucide="scale"></i> Long/Short Ratio</div>
        <div class="ls-container">
          <!-- ② Coin Tabs -->
          <div class="ls-coin-tabs">
            <button class="ls-tab active" data-coin="BTC">BTC</button>
            <button class="ls-tab" data-coin="ETH">ETH</button>
            <button class="ls-tab" data-coin="SOL">SOL</button>
          </div>

          <!-- ⑥ Alert threshold zone -->
          <div class="ls-alert-zone" id="ls-alert-zone" style="display:none;">
            <span class="ls-alert-icon">?</span>
            <span class="ls-alert-text" id="ls-alert-text">EXTREME LONG</span>
          </div>

          <!-- 3D Bar Gauge + ⑤ Wave animation -->
          <div class="ls-bar-3d">
            <div class="ls-bar-track">
              <div id="ls-long" class="ls-fill long" style="width: 50%;">
                <span class="ls-val">50%</span>
              </div>
              <div id="ls-short" class="ls-fill short" style="width: 50%;">
                <span class="ls-val">50%</span>
              </div>
            </div>
            <div class="ls-bar-shine"></div>
            <canvas class="ls-wave-canvas" id="ls-wave-canvas" width="300" height="32"></canvas>
          </div>

          <!-- Percentage indicators -->
          <div class="ls-indicators">
            <div class="ls-indicator long-ind">
              <span class="ls-dot dot-long"></span>
              <span class="ls-ind-label">LONG</span>
              <span class="ls-ind-val" id="ls-long-pct">50%</span>
            </div>
            <div class="ls-indicator">
              <div class="ls-ratio-display" id="ls-ratio-num">1.00</div>
            </div>
            <div class="ls-indicator short-ind">
              <span class="ls-ind-val" id="ls-short-pct">50%</span>
              <span class="ls-ind-label">SHORT</span>
              <span class="ls-dot dot-short"></span>
            </div>
          </div>

          <!-- ③ Sentiment Arc Gauge -->
          <div class="ls-sentiment-wrap">
            <svg class="ls-arc-gauge" viewBox="0 0 120 70" width="120" height="70">
              <defs>
                <linearGradient id="ls-arc-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#dc2626"/>
                  <stop offset="50%" stop-color="#fbbf24"/>
                  <stop offset="100%" stop-color="#059669"/>
                </linearGradient>
              </defs>
              <path d="M 10 62 A 50 50 0 0 1 110 62" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="7" stroke-linecap="round"/>
              <path id="ls-arc-fill" d="M 10 62 A 50 50 0 0 1 110 62" fill="none" stroke="url(#ls-arc-grad)" stroke-width="7" stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="78" style="transition: stroke-dashoffset 1s ease;"/>
              <circle id="ls-arc-dot" cx="60" cy="12" r="4" fill="var(--neon-cyan)" stroke="var(--bg-card)" stroke-width="2"/>
              <text x="10" y="70" font-size="6" fill="var(--text-muted)" font-family="var(--font-mono)">SHORT</text>
              <text x="90" y="70" font-size="6" fill="var(--text-muted)" font-family="var(--font-mono)">LONG</text>
              <text id="ls-arc-label" x="60" y="52" text-anchor="middle" font-size="8" fill="var(--neon-cyan)" font-family="var(--font-mono)" font-weight="700">NEUTRAL</text>
            </svg>
          </div>

          <!-- ① History mini sparkline -->
          <div class="ls-history-wrap">
            <span class="ls-history-title">24H L/S TREND</span>
            <canvas id="ls-history-canvas" width="240" height="36"></canvas>
          </div>

          <!-- ④ Funding Rate Heatmap -->
          <div class="ls-funding-heatmap" id="funding-rates">
            <span class="fr-heatmap-title">FUNDING RATE <span class="info-tooltip" data-tip="양수면 롱 과밀(숏에 유리), 음수면 숏 과밀(롱에 유리). 극단값은 반전 시그널.">(?)</span></span>
            <div class="fr-blocks">
              <div class="fr-block" id="fr-block-btc">
                <span class="fr-coin">BTC</span>
                <span class="fr-rate" id="fr-btc">?</span>
              </div>
              <div class="fr-block" id="fr-block-eth">
                <span class="fr-coin">ETH</span>
                <span class="fr-rate" id="fr-eth">?</span>
              </div>
              <div class="fr-block" id="fr-block-sol">
                <span class="fr-coin">SOL</span>
                <span class="fr-rate" id="fr-sol">?</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alpha Scanner -->
      <div class="glass-panel scanner-panel" id="scanner-section" data-pro="true" style="margin-bottom:15px;">
        <div class="panel-title" data-i18n="alpha_scanner"><i data-lucide="radar"></i> Alpha Scanner (15m) <span class="scanner-live-dot"></span> <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
        <div id="scanner-feed" style="min-height:60px; max-height:200px; overflow-y:auto;">
          <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div></div>
        </div>
        </div>
      </div>

      <!-- Price Alerts -->
      <div class="glass-panel" style="margin-bottom:15px;">
        <div class="panel-title" data-i18n="price_alerts"><i data-lucide="bell"></i> Price Alerts <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <div id="price-alerts-container" style="min-height:40px;"></div>
        </div>
      </div>

      <!-- Whale Alert Feed -->
      <div class="glass-panel" id="whale-section" data-pro="true" style="height: 150px; min-height:150px;">
        <div class="panel-title" data-i18n="whale_alert"><i data-lucide="anchor"></i> Whale Alert <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
        <div id="whale-feed" style="overflow-y:auto; max-height:105px; font-size:0.72rem;">
          <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div></div>
        </div>
        </div>
      </div>

      <!-- Whale Wallet Tracker -->
      <div class="glass-panel whale-wallet-panel" data-pro="true" style="min-height:120px;">
        <div class="panel-title" data-i18n="whale_wallets"><i data-lucide="wallet"></i> Whale Wallets (BTC) <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <div id="whale-wallet-feed" style="overflow-y:auto; max-height:150px; font-size:0.72rem;">
            <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div></div>
          </div>
        </div>
      </div>

      <!-- On-Chain Radar (Upgraded v2) -->
      <div class="glass-panel onchain-panel" id="onchain-section" data-pro="true" style="min-height:200px;">
        <div class="panel-title" data-i18n="onchain_radar"><i data-lucide="link"></i> On-Chain Radar <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">

          <!-- 1. Open Interest -->
          <div class="oc-section" data-oc-section="oi">
            <div class="oc-section-hdr" data-oc-toggle="oi">
              <span class="oc-subtitle">Open Interest</span>
              <i data-lucide="chevron-down" class="oc-toggle-icon" style="width:12px;height:12px;"></i>
            </div>
            <div class="oc-section-body" id="oc-oi-body">
              <div id="oc-oi" class="oc-oi-grid">
                <div class="skeleton-loader"><div class="skeleton skeleton-line"></div></div>
              </div>
            </div>
          </div>

          <!-- 2. Funding Rates -->
          <div class="oc-section" data-oc-section="funding">
            <div class="oc-section-hdr" data-oc-toggle="funding">
              <span class="oc-subtitle">Funding Rates</span>
              <i data-lucide="chevron-down" class="oc-toggle-icon" style="width:12px;height:12px;"></i>
            </div>
            <div class="oc-section-body" id="oc-funding-body">
              <div id="oc-funding" class="oc-funding-grid">
                <div class="skeleton-loader"><div class="skeleton skeleton-line"></div></div>
              </div>
            </div>
          </div>

          <!-- 3. BTC Mempool Fees -->
          <div class="oc-section" data-oc-section="mempool">
            <div class="oc-section-hdr" data-oc-toggle="mempool">
              <span class="oc-subtitle">BTC Mempool Fees (sat/vB)</span>
              <i data-lucide="chevron-down" class="oc-toggle-icon" style="width:12px;height:12px;"></i>
            </div>
            <div class="oc-section-body" id="oc-mempool-body">
              <div class="oc-congestion-bar" id="oc-congestion">
                <div class="oc-congestion-fill" id="oc-congestion-fill"></div>
                <span class="oc-congestion-label" id="oc-congestion-label">--</span>
              </div>
              <div id="oc-mempool" class="oc-fees-row">
                <span class="oc-fee-item"><span class="oc-fee-label">?</span><span class="oc-fee-val" id="oc-fee-fast">??</span></span>
                <span class="oc-fee-item"><span class="oc-fee-label">30m</span><span class="oc-fee-val" id="oc-fee-30m">??</span></span>
                <span class="oc-fee-item"><span class="oc-fee-label">1h</span><span class="oc-fee-val" id="oc-fee-1h">??</span></span>
                <span class="oc-fee-item"><span class="oc-fee-label">??</span><span class="oc-fee-val" id="oc-fee-eco">??</span></span>
              </div>
            </div>
          </div>

          <!-- 4. Network Hashrate -->
          <div class="oc-section" data-oc-section="hashrate">
            <div class="oc-section-hdr" data-oc-toggle="hashrate">
              <span class="oc-subtitle">Network Hashrate</span>
              <i data-lucide="chevron-down" class="oc-toggle-icon" style="width:12px;height:12px;"></i>
            </div>
            <div class="oc-section-body" id="oc-hashrate-body">
              <div class="oc-hashrate-row">
                <span id="oc-hashrate" class="oc-hashrate-val">??</span>
                <canvas id="oc-hashrate-spark" width="120" height="32" style="width:120px;height:32px;"></canvas>
              </div>
            </div>
          </div>

          <!-- 5. Liquidation Zones -->
          <div class="oc-section" data-oc-section="liq">
            <div class="oc-section-hdr" data-oc-toggle="liq">
              <span class="oc-subtitle">Liquidation Zones</span>
              <i data-lucide="chevron-down" class="oc-toggle-icon" style="width:12px;height:12px;"></i>
            </div>
            <div class="oc-section-body" id="oc-liq-body">
              <div id="oc-liq-summary" class="oc-liq-summary">
                <div class="skeleton-loader"><div class="skeleton skeleton-line"></div></div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Live Wire (Upgraded v2) -->
      <div class="glass-panel news-panel-v3" id="news-section" style="flex: 1; min-height: 200px;">
        <div class="panel-title" data-i18n="live_wire"><i data-lucide="rss"></i> Live Wire <span class="news-count-badge" id="news-count">0</span> <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i></div>
        <div class="panel-body">
          <!-- Sentiment summary bar -->
          <div class="news-sentiment-bar" id="news-sentiment-bar">
            <div class="news-sbar-fill bull" id="ns-bull" style="width:33%"></div>
            <div class="news-sbar-fill neutral" id="ns-neutral" style="width:34%"></div>
            <div class="news-sbar-fill bear" id="ns-bear" style="width:33%"></div>
          </div>
          <div class="news-sbar-legend" id="news-sbar-legend">
            <span class="ns-leg bull"><span class="ns-dot bull"></span>Bullish <span id="ns-bull-pct">0%</span></span>
            <span class="ns-leg neutral"><span class="ns-dot neutral"></span>Neutral <span id="ns-neutral-pct">0%</span></span>
            <span class="ns-leg bear"><span class="ns-dot bear"></span>Bearish <span id="ns-bear-pct">0%</span></span>
          </div>
          <!-- Breaking news banner -->
          <div class="news-breaking" id="news-breaking" style="display:none;">
            <span class="news-breaking-badge">BREAKING</span>
            <a class="news-breaking-link" id="news-breaking-link" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
          <!-- Source filter tabs -->
          <div class="news-filter-tabs" id="news-filter-tabs">
            <button class="news-filter-btn active" data-source="all">All</button>
          </div>
          <!-- News feed -->
          <div id="news-feed" style="overflow-y:auto; max-height:380px; font-size:0.8rem;">
            <div class="skeleton-loader"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line medium"></div><div class="skeleton skeleton-line short"></div><div class="skeleton skeleton-line"></div></div>
          </div>
        </div>
      </div>

      <!-- ═══ Portfolio Tracker ═══ -->
      <div class="glass-panel" id="portfolio-section" style="margin-bottom:15px;">
        <div class="panel-title"><i data-lucide="wallet"></i> Portfolio Tracker
          <span id="sse-status-dot" class="sse-dot disconnected" style="margin-left:auto;"></span>
          <span id="sse-status-label" style="font-size:0.6rem;color:var(--text-muted);margin-left:2px;">LIVE</span>
          <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i>
        </div>
        <div class="panel-body">
          <!-- Add Holding Form -->
          <div class="pf-add-form">
            <input type="text" id="pf-symbol" placeholder="Symbol (BTC)" class="pf-input" style="width:70px;" />
            <input type="number" id="pf-amount" placeholder="Amount" class="pf-input" step="any" style="width:80px;" />
            <input type="number" id="pf-avg-price" placeholder="Avg Price ($)" class="pf-input" step="any" style="width:90px;" />
            <button onclick="RyzmPortfolio.addHolding()" class="pf-add-btn">+ Add</button>
          </div>
          <!-- Summary -->
          <div id="portfolio-summary" class="pf-summary" style="display:none;"></div>
          <!-- Holdings Table -->
          <div id="portfolio-holdings" style="overflow-x:auto;">
            <div style="text-align:center;color:var(--text-muted);padding:20px;font-size:0.75rem;">Sign in to track your portfolio.</div>
          </div>
          <!-- Push Notification Toggle -->
          <div style="margin-top:10px;text-align:center;">
            <button id="push-toggle-btn" class="push-toggle push-off" onclick="RyzmPush.isEnabled() ? RyzmPush.unsubscribe() : RyzmPush.subscribe()">🔕 Notifications OFF</button>
          </div>
        </div>
      </div>

      <!-- ═══ Council Accuracy Dashboard ═══ -->
      <div class="glass-panel" id="accuracy-section" style="margin-bottom:15px;">
        <div class="panel-title"><i data-lucide="target"></i> Council Accuracy
          <i data-lucide="chevron-down" class="collapse-icon" style="width:14px;height:14px;"></i>
        </div>
        <div class="panel-body">
          <div id="accuracy-content">
            <div style="text-align:center;color:var(--text-muted);padding:20px;font-size:0.75rem;">Loading accuracy data...</div>
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- Briefing Panel (Floating Bottom) -->
  <div id="briefing-panel" class="briefing-panel" style="display:none;">
    <div class="briefing-header">
      <div class="briefing-badge">BRIEFING</div>
      <span id="briefing-title" class="briefing-title">??</span>
      <span id="briefing-time" class="briefing-time"></span>
      <button id="briefing-close" class="briefing-close"><i data-lucide="x" style="width:14px;height:14px;"></i></button>
    </div>
    <div id="briefing-content" class="briefing-content"></div>
  </div>

  <!-- Ask Ryzm Chat Float Button -->
  <button id="chat-float-btn" class="chat-float-btn" title="Ask Ryzm">
    <i data-lucide="message-circle"></i>
  </button>

  <!-- Chat Overlay -->
  <div id="chat-overlay" class="chat-overlay">
    <div class="chat-header">
      <span data-i18n-text="ask_ryzm"><i data-lucide="bot"></i> Ask Ryzm</span>
      <button id="chat-close" class="chat-close-btn">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Ask anything about the market..." />
      <button id="chat-send">
        <i data-lucide="send"></i>
      </button>
    </div>
  </div>

  <!-- Ryzm Chart Modal (price card click) -->
  <div id="tv-modal" class="tv-modal" style="display:none;">
    <div class="tv-modal-content">
      <div class="tv-modal-header">
        <span id="tv-modal-title">BTC/USDT</span>
        <button id="tv-modal-close" class="chat-close-btn"><i data-lucide="x"></i></button>
      </div>
      <div id="tv-chart-container" style="height:400px;"></div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot" id="connection-status"></span>
      <span data-i18n-text="system_online">SYSTEM ONLINE</span>
    </div>
    <div class="status-item">
      <i data-lucide="activity" style="width:12px;height:12px;"></i>
      <span id="last-update" data-i18n-prefix="last_update">Last Update: --:--</span>
    </div>
    <div class="status-item source-status" id="source-status">
      <i data-lucide="database" style="width:12px;height:12px;"></i>
      <span id="data-sources">-- Sources</span>
      <div class="source-tooltip" id="source-tooltip"></div>
    </div>
    <div class="status-item">
      <i data-lucide="zap" style="width:12px;height:12px;"></i>
      <span>Ryzm Terminal v7.0</span>
    </div>
  </div>

  <!-- JS Modules (v8.2 — MATIC→POL rename, config upgrades) -->
  <script src="/static/js/api.js?v=8.2"></script>
  <script src="/static/js/binance-direct.js?v=8.2"></script>
  <script src="/static/js/chart.js?v=8.2"></script>
  <script src="/static/js/core.js?v=8.2"></script>
  <script src="/static/js/data.js?v=8.2"></script>
  <script src="/static/js/council.js?v=8.2"></script>
  <script src="/static/js/ui.js?v=8.2"></script>
  <script src="/static/js/portfolio.js?v=8.2"></script>

  <!-- ?먥븧??Auth Modal ?먥븧??-->
  <div id="auth-modal" class="auth-modal" style="display:none;">
    <div class="auth-modal-inner">
      <button class="auth-close" onclick="toggleAuthModal()">&times;</button>
      <div class="auth-logo"><span class="logo-dot"></span> Ryzm_OS</div>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">LOGIN</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">REGISTER</button>
      </div>
      <!-- Login Form -->
      <form id="auth-login-form" class="auth-form" onsubmit="handleLogin(event)">
        <input type="email" id="login-email" placeholder="Email" required autocomplete="email" />
        <input type="password" id="login-password" placeholder="Password" required autocomplete="current-password" />
        <button type="submit" class="auth-submit">Sign In</button>
        <div id="login-error" class="auth-error"></div>
        <div style="text-align:center;margin-top:8px;">
          <a href="#" onclick="showForgotPassword(event)" style="color:var(--neon-cyan);font-size:0.72rem;text-decoration:none;">Forgot password?</a>
        </div>
      </form>
      <!-- Forgot Password Form -->
      <form id="auth-forgot-form" class="auth-form" style="display:none;" onsubmit="handleForgotPassword(event)">
        <p style="color:var(--text-secondary);font-size:0.78rem;margin:0 0 12px;">Enter your email to receive a password reset link.</p>
        <input type="email" id="forgot-email" placeholder="Email" required autocomplete="email" />
        <button type="submit" class="auth-submit">Send Reset Link</button>
        <div id="forgot-error" class="auth-error"></div>
        <div id="forgot-success" style="color:var(--neon-green);font-size:0.75rem;display:none;margin-top:6px;"></div>
        <div style="text-align:center;margin-top:8px;">
          <a href="#" onclick="backToLogin(event)" style="color:var(--neon-cyan);font-size:0.72rem;text-decoration:none;">??Back to login</a>
        </div>
      </form>
      <!-- Register Form -->
      <form id="auth-register-form" class="auth-form" style="display:none;" onsubmit="handleRegister(event)">
        <input type="text" id="reg-name" placeholder="Display Name (optional)" maxlength="50" autocomplete="name" />
        <input type="email" id="reg-email" placeholder="Email" required autocomplete="email" />
        <input type="password" id="reg-password" placeholder="Password (8+ chars)" required minlength="8" autocomplete="new-password" />
        <input type="text" id="reg-invite-code" placeholder="Invite Code (if required)" maxlength="50" style="display:none;" autocomplete="off" />
        <label class="tos-checkbox" style="display:flex;align-items:flex-start;gap:8px;margin:8px 0;font-size:0.72rem;color:var(--text-secondary);cursor:pointer;">
          <input type="checkbox" id="reg-tos" required style="margin-top:2px;accent-color:var(--neon-cyan);" />
          <span>I agree to the <a href="#" onclick="openTosModal(event)" style="color:var(--neon-cyan);text-decoration:underline;">Terms of Service</a> and understand that Ryzm Terminal is for informational purposes only, not financial advice.</span>
        </label>
        <button type="submit" class="auth-submit">Create Account</button>
        <div id="reg-error" class="auth-error"></div>
      </form>
      <!-- Logged-in state -->
      <div id="auth-profile" class="auth-profile" style="display:none;">
        <div id="email-verify-banner" style="display:none;background:rgba(244,63,94,0.15);border:1px solid rgba(244,63,94,0.3);border-radius:4px;padding:8px 12px;margin-bottom:10px;font-size:0.72rem;">
          <span style="color:var(--neon-red);">? Email not verified.</span>
          <a href="#" onclick="resendVerification(event)" style="color:var(--neon-cyan);text-decoration:underline;margin-left:4px;">Resend</a>
        </div>
        <div class="auth-profile-info">
          <div class="auth-email" id="profile-email"></div>
          <div class="auth-tier" id="profile-tier"></div>
        </div>

        <!-- Edit Display Name -->
        <div id="profile-name-section" style="margin:8px 0;">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:0.72rem;color:var(--text-muted);">Name:</span>
            <span id="profile-display-name" style="font-size:0.78rem;color:var(--text-primary);font-weight:500;"></span>
            <button onclick="toggleNameEdit()" style="background:none;border:none;color:var(--neon-cyan);cursor:pointer;font-size:0.65rem;padding:2px 6px;">? Edit</button>
          </div>
          <div id="name-edit-row" style="display:none;margin-top:4px;gap:4px;align-items:center;">
            <input type="text" id="name-edit-input" maxlength="50" style="flex:1;padding:4px 8px;font-size:0.75rem;background:var(--bg-input);border:1px solid var(--border-dim);border-radius:4px;color:var(--text-primary);" />
            <button onclick="saveDisplayName()" style="padding:4px 10px;font-size:0.68rem;background:var(--neon-cyan);color:#000;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Save</button>
          </div>
        </div>

        <!-- Change Password Toggle -->
        <div id="profile-pw-section" style="margin:6px 0;">
          <button onclick="togglePasswordChange()" style="background:none;border:none;color:var(--neon-cyan);cursor:pointer;font-size:0.7rem;padding:0;">?? Change Password</button>
          <div id="pw-change-form" style="display:none;margin-top:6px;">
            <input type="password" id="pw-current" placeholder="Current password" style="width:100%;padding:4px 8px;font-size:0.75rem;background:var(--bg-input);border:1px solid var(--border-dim);border-radius:4px;color:var(--text-primary);margin-bottom:4px;" />
            <input type="password" id="pw-new" placeholder="New password (8+)" minlength="8" style="width:100%;padding:4px 8px;font-size:0.75rem;background:var(--bg-input);border:1px solid var(--border-dim);border-radius:4px;color:var(--text-primary);margin-bottom:4px;" />
            <div style="display:flex;gap:4px;">
              <button onclick="submitPasswordChange()" style="flex:1;padding:4px 10px;font-size:0.68rem;background:var(--neon-cyan);color:#000;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Update</button>
              <button onclick="togglePasswordChange()" style="padding:4px 10px;font-size:0.68rem;background:transparent;color:var(--text-muted);border:1px solid var(--border-dim);border-radius:4px;cursor:pointer;">Cancel</button>
            </div>
            <div id="pw-change-msg" style="font-size:0.68rem;margin-top:4px;"></div>
          </div>
        </div>

        <button class="auth-submit" id="btn-upgrade" style="display:none;" onclick="handleUpgrade()">
          <i data-lucide="crown" style="width:14px;height:14px;"></i> Upgrade to PRO
        </button>
        <!-- Manage Subscription (Pro only) -->
        <button class="auth-submit" id="btn-manage-sub" style="display:none;margin-top:6px;background:transparent;border:1px solid var(--neon-cyan);color:var(--neon-cyan);font-size:0.75rem;" onclick="openStripePortal()">
          <i data-lucide="credit-card" style="width:14px;height:14px;"></i> Manage Subscription
        </button>
        <button class="auth-submit" id="btn-open-journal" onclick="openJournalModal()" style="margin-top:6px;background:transparent;border:1px solid var(--neon-green);color:var(--neon-green);font-size:0.75rem;">
          <i data-lucide="book-open" style="width:14px;height:14px;"></i> Signal Journal
        </button>
        <button class="auth-logout" onclick="handleLogout()">Logout</button>
      </div>
    </div>
  </div>

  <script>
  /* ?? Auth UI Logic ?? */
  let _authUser = null;
  function toggleAuthModal() {
    const m = document.getElementById('auth-modal');
    m.style.display = m.style.display === 'none' ? 'flex' : 'none';
  }
  function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('auth-login-form').style.display = tab === 'login' ? '' : 'none';
    document.getElementById('auth-register-form').style.display = tab === 'register' ? '' : 'none';
    document.getElementById('auth-forgot-form').style.display = 'none';
    document.getElementById('auth-profile').style.display = 'none';
    event.target.classList.add('active');
  }
  function showForgotPassword(e) {
    e.preventDefault();
    document.getElementById('auth-login-form').style.display = 'none';
    document.getElementById('auth-forgot-form').style.display = '';
    document.querySelectorAll('.auth-tab').forEach(t => t.style.display = 'none');
  }
  function backToLogin(e) {
    e.preventDefault();
    document.getElementById('auth-forgot-form').style.display = 'none';
    document.getElementById('auth-login-form').style.display = '';
    document.querySelectorAll('.auth-tab').forEach(t => t.style.display = '');
  }
  async function handleForgotPassword(e) {
    e.preventDefault();
    const errEl = document.getElementById('forgot-error');
    const sucEl = document.getElementById('forgot-success');
    errEl.textContent = ''; sucEl.style.display = 'none';
    try {
      const data = await apiFetch('/api/auth/forgot-password', {
        method: 'POST', headers: {'Content-Type':'application/json'}, silent: true,
        body: JSON.stringify({ email: document.getElementById('forgot-email').value }),
      });
      sucEl.textContent = data.message || 'Reset link sent.';
      sucEl.style.display = 'block';
    } catch (e) { errEl.textContent = e.data?.detail || 'Connection error'; }
  }
  async function resendVerification(e) {
    e.preventDefault();
    try {
      const data = await apiFetch('/api/auth/resend-verification', { method: 'POST', silent: true });
      showToast('info', 'Email', data.message || 'Verification email resent.');
    } catch { showToast('error', 'Error', 'Failed to resend verification.'); }
  }
  async function handleLogin(e) {
    e.preventDefault();
    const errEl = document.getElementById('login-error');
    errEl.textContent = '';
    try {
      const data = await apiFetch('/api/auth/login', {
        method: 'POST', headers: {'Content-Type':'application/json'}, silent: true,
        body: JSON.stringify({ email: document.getElementById('login-email').value, password: document.getElementById('login-password').value }),
      });
      localStorage.setItem('ryzm_token', data.token);
      _authUser = data;
      updateAuthUI(data);
      showToast('success', 'Welcome', `Logged in as ${data.email}`);
    } catch (e) { errEl.textContent = e.data?.detail || 'Connection error'; }
  }
  async function handleRegister(e) {
    e.preventDefault();
    const errEl = document.getElementById('reg-error');
    errEl.textContent = '';
    const tosChecked = document.getElementById('reg-tos').checked;
    if (!tosChecked) { errEl.textContent = 'You must accept the Terms of Service.'; return; }
    try {
      const data = await apiFetch('/api/auth/register', {
        method: 'POST', headers: {'Content-Type':'application/json'}, silent: true,
        body: JSON.stringify({
          email: document.getElementById('reg-email').value,
          password: document.getElementById('reg-password').value,
          display_name: document.getElementById('reg-name').value,
          invite_code: document.getElementById('reg-invite-code')?.value || '',
        }),
      });
      localStorage.setItem('ryzm_token', data.token);
      _authUser = data;
      updateAuthUI(data);
      showToast('success', 'Account Created', data.message || 'Welcome to Ryzm Terminal!');
    } catch (e) { errEl.textContent = e.data?.detail || 'Connection error'; }
  }
  async function handleLogout() {
    await apiFetch('/api/auth/logout', { method: 'POST', silent: true }).catch(() => {});
    localStorage.removeItem('ryzm_token');
    _authUser = null;
    updateAuthUI(null);
    toggleAuthModal();
    showToast('info', 'Logged Out', 'Session ended.');
  }
  async function handleUpgrade() {
    try {
      const data = await apiFetch('/api/payments/create-checkout', { method: 'POST' });
      if (data.checkout_url) window.location.href = data.checkout_url;
      else showToast('warning', 'Payment', data.detail || 'Stripe not configured yet.');
    } catch { showToast('error', 'Error', 'Payment system unavailable.'); }
  }
  function updateAuthUI(user) {
    const label = document.getElementById('auth-label');
    const badge = document.querySelector('.pro-badge');
    const loginForm = document.getElementById('auth-login-form');
    const regForm = document.getElementById('auth-register-form');
    const forgotForm = document.getElementById('auth-forgot-form');
    const profile = document.getElementById('auth-profile');
    const planBadge = document.getElementById('header-plan-badge');
    const verifyBanner = document.getElementById('email-verify-banner');
    if (user && user.email) {
      label.textContent = user.display_name || user.email.split('@')[0];
      if (user.tier === 'pro' && badge) badge.style.display = 'inline-block';
      loginForm.style.display = 'none';
      regForm.style.display = 'none';
      forgotForm.style.display = 'none';
      profile.style.display = '';
      document.getElementById('profile-email').textContent = user.email;
      document.getElementById('profile-tier').textContent = user.tier === 'pro' ? 'PRO' : 'FREE';
      document.getElementById('profile-tier').className = 'auth-tier tier-' + user.tier;
      document.getElementById('btn-upgrade').style.display = user.tier === 'pro' ? 'none' : '';
      document.querySelectorAll('.auth-tab').forEach(t => t.style.display = 'none');
      // Display name in profile
      const nameEl = document.getElementById('profile-display-name');
      if (nameEl) nameEl.textContent = user.display_name || user.email.split('@')[0];
      // Manage subscription button (pro only)
      const subBtn = document.getElementById('btn-manage-sub');
      if (subBtn) subBtn.style.display = user.tier === 'pro' ? '' : 'none';
      // Email verification banner
      if (verifyBanner) {
        verifyBanner.style.display = user.email_verified === false ? 'block' : 'none';
      }
      // Header plan badge
      if (planBadge) {
        planBadge.style.display = 'inline-block';
        if (user.is_admin) {
          planBadge.textContent = '?ADMIN';
          planBadge.style.background = 'rgba(234,179,8,0.3)';
          planBadge.style.color = '#eab308';
        } else if (user.tier === 'pro') {
          planBadge.textContent = 'PRO';
          planBadge.style.background = 'rgba(201,169,110,0.3)';
          planBadge.style.color = 'var(--neon-cyan)';
        } else {
          planBadge.textContent = 'FREE';
          planBadge.style.background = 'rgba(255,255,255,0.08)';
          planBadge.style.color = 'var(--text-muted)';
        }
      }
      // Header upgrade tab ? visible for free users and admins
      const upgradeTab = document.getElementById('header-upgrade-tab');
      if (upgradeTab) {
        const showTab = user.is_admin || user.tier !== 'pro';
        upgradeTab.style.display = showTab ? 'inline-flex' : 'none';
        if (typeof lucide !== 'undefined') lucide.createIcons();
      }
    } else {
      label.textContent = 'Login';
      if (badge) badge.style.display = 'none';
      loginForm.style.display = '';
      regForm.style.display = 'none';
      forgotForm.style.display = 'none';
      profile.style.display = 'none';
      document.querySelectorAll('.auth-tab').forEach(t => t.style.display = '');
      if (planBadge) planBadge.style.display = 'none';
      if (verifyBanner) verifyBanner.style.display = 'none';
      const upgradeTab2 = document.getElementById('header-upgrade-tab');
      if (upgradeTab2) upgradeTab2.style.display = 'none';
    }
    // Apply Pro panel gating
    applyProGating(user);
  }
  // Check auth on load
  (async function checkAuth() {
    try {
      _authUser = await apiFetch('/api/auth/profile', { silent: true });
      updateAuthUI(_authUser);
    } catch {
      // Clear stale token (DB may have been reset on deploy)
      localStorage.removeItem('ryzm_token');
      updateAuthUI(null);
    }
  })();
  // Handle Stripe checkout return (payment=success / payment=canceled)
  (function handlePaymentReturn() {
    const params = new URLSearchParams(window.location.search);
    const payment = params.get('payment');
    if (payment === 'success') {
      showToast('success', 'Payment', 'Payment successful! Activating Pro...');
      // Re-fetch profile to confirm Pro tier
      setTimeout(async () => {
        try {
          _authUser = await apiFetch('/api/auth/profile', { silent: true });
          updateAuthUI(_authUser);
          if (_authUser?.tier === 'pro') showToast('success', 'Pro Active', 'Welcome to Ryzm Pro!');
          else showToast('info', 'Processing', 'Payment is being processed. Refresh in a moment.');
        } catch {}
      }, 2000);
      window.history.replaceState({}, '', window.location.pathname);
    } else if (payment === 'canceled') {
      showToast('info', 'Canceled', 'Payment canceled. You can try again anytime.');
      window.history.replaceState({}, '', window.location.pathname);
    }
  })();
  // Detect beta mode and show invite code field
  (async function checkBetaMode() {
    try {
      const cfg = await fetch('/api/config').then(r => r.json());
      if (cfg.beta_mode) {
        const el = document.getElementById('reg-invite-code');
        if (el) el.style.display = '';
      }
    } catch {}
  })();
  // Handle email verification from URL params
  (function checkVerifyParam() {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('verify_token') || params.get('token');
    const path = window.location.pathname;
    if (path === '/verify-email' && token) {
      apiFetch(`/api/auth/verify-email?token=${encodeURIComponent(token)}`, { silent: true })
        .then(data => {
          if (data.status === 'verified') {
            showToast('success', 'Verified', 'Email verified successfully!');
            if (_authUser) { _authUser.email_verified = true; updateAuthUI(_authUser); }
          } else {
            showToast('error', 'Error', data.detail || 'Verification failed.');
          }
          window.history.replaceState({}, '', '/');
        })
        .catch(() => showToast('error', 'Error', 'Verification failed.'));
    }
    // Handle password reset from URL
    if (path === '/reset-password' && token) {
      openResetPasswordModal(token);
      window.history.replaceState({}, '', '/');
    }
  })();

  /* ── Profile Management Functions ── */
  function toggleNameEdit() {
    const row = document.getElementById('name-edit-row');
    if (!row) return;
    const visible = row.style.display !== 'none';
    row.style.display = visible ? 'none' : 'flex';
    if (!visible) {
      const inp = document.getElementById('name-edit-input');
      inp.value = _authUser?.display_name || '';
      inp.focus();
    }
  }
  async function saveDisplayName() {
    const inp = document.getElementById('name-edit-input');
    const name = inp?.value.trim();
    if (!name) return;
    try {
      const data = await apiFetch('/api/auth/update-profile', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ display_name: name }),
      });
      if (_authUser) _authUser.display_name = data.display_name;
      updateAuthUI(_authUser);
      document.getElementById('name-edit-row').style.display = 'none';
      showToast('success', 'Profile', 'Display name updated.');
    } catch (e) { showToast('error', 'Error', e.data?.detail || 'Failed to update.'); }
  }
  function togglePasswordChange() {
    const form = document.getElementById('pw-change-form');
    if (!form) return;
    const visible = form.style.display !== 'none';
    form.style.display = visible ? 'none' : 'block';
    if (!visible) { document.getElementById('pw-current').value = ''; document.getElementById('pw-new').value = ''; }
    document.getElementById('pw-change-msg').textContent = '';
  }
  async function submitPasswordChange() {
    const cur = document.getElementById('pw-current').value;
    const nw = document.getElementById('pw-new').value;
    const msg = document.getElementById('pw-change-msg');
    if (!cur || nw.length < 8) { msg.style.color = 'var(--neon-red)'; msg.textContent = 'New password: 8+ characters.'; return; }
    try {
      await apiFetch('/api/auth/change-password', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ current_password: cur, new_password: nw }),
      });
      msg.style.color = 'var(--neon-green)'; msg.textContent = 'Password changed!';
      setTimeout(() => togglePasswordChange(), 1500);
    } catch (e) { msg.style.color = 'var(--neon-red)'; msg.textContent = e.data?.detail || 'Failed.'; }
  }
  async function openStripePortal() {
    try {
      const data = await apiFetch('/api/payments/portal');
      if (data.portal_url) window.location.href = data.portal_url;
      else showToast('warning', 'Portal', 'Stripe portal not available.');
    } catch { showToast('error', 'Error', 'Cannot open subscription portal.'); }
  }
  </script>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       UPGRADE MODAL (Plan Gate)
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <div id="upgrade-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner">
      <button class="upgrade-close" onclick="closeUpgradeModal()">&times;</button>
      <div class="upgrade-logo">Ryzm Pro</div>
      <div style="font-size:1.3rem;font-weight:800;color:var(--neon-cyan);margin:6px 0 2px;font-family:var(--font-head);">$20<span style="font-size:0.7rem;font-weight:400;color:var(--text-secondary);">/month</span></div>
      <p id="upgrade-context-msg" class="upgrade-context" style="color:var(--text-secondary);margin:8px 0 16px;font-size:0.82rem;"></p>
      <table class="upgrade-compare">
        <thead>
          <tr><th></th><th>Free</th><th style="color:var(--neon-cyan);">Pro</th></tr>
        </thead>
        <tbody>
          <tr><td>AI Council</td><td>10/day</td><td>Unlimited</td></tr>
          <tr><td>Trade Validator</td><td>3/day</td><td>Unlimited</td></tr>
          <tr><td>Ask Ryzm Chat</td><td>20/day</td><td>Unlimited</td></tr>
          <tr><td>Pro Panels</td><td>Locked</td><td>Full Access</td></tr>
          <tr><td>Price Alerts</td><td>5</td><td>100</td></tr>
          <tr><td>Data Export</td><td>—</td><td>CSV</td></tr>
          <tr><td>Council History</td><td>7 days</td><td>90 days</td></tr>
          <tr><td>Signal Journal</td><td>20 entries</td><td>500 entries</td></tr>
        </tbody>
      </table>
      <div id="trial-slot"></div>
      <button class="upgrade-cta" id="upgrade-cta-btn" onclick="handleUpgradeFromModal()">
        Upgrade to Pro ? $20/mo
      </button>
      <div style="font-size:0.65rem; color:var(--text-tertiary); margin-top:8px;">Cancel anytime · Stripe secure checkout</div>
    </div>
  </div>

  <script>
  /* ?? Upgrade Modal logic ?? */
  const _upgradeMessages = {
    council_limit:   'You\'ve used all free AI Council runs today.',
    validator_limit: 'Daily free validation limit reached.',
    chat_limit:      'Daily free chat messages exhausted.',
    alerts_limit:    'Free plan alert limit reached.',
    panel_locked:    'This panel requires Pro. Upgrade to unlock.',
    general:         'Unlock unlimited access to all Ryzm features.'
  };
  function openUpgradeModal(context) {
    const modal = document.getElementById('upgrade-modal');
    if (!modal) return;
    const msg = document.getElementById('upgrade-context-msg');
    if (msg) msg.textContent = _upgradeMessages[context] || _upgradeMessages.general;
    modal.style.display = 'flex';
  }
  function closeUpgradeModal() {
    const m = document.getElementById('upgrade-modal'); if (m) m.style.display = 'none';
  }
  async function handleUpgradeFromModal() {
    try {
      await apiFetch('/api/auth/profile', { silent: true });
      const data = await apiFetch('/api/payments/create-checkout', { method: 'POST' });
      if (data.checkout_url) window.location.href = data.checkout_url;
      else showToast('warning', 'Payment', data.detail || 'Stripe not configured.');
    } catch (e) {
      if (e.status === 401) { closeUpgradeModal(); toggleAuthModal(); return; }
      if (e.status === 503) { showToast('warning', 'Payment', 'Payment system is being set up. Please try again later.'); return; }
      showToast('error', 'Error', 'Payment unavailable.');
    }
  }
  // Close on backdrop click
  document.getElementById('upgrade-modal')?.addEventListener('click', e => {
    if (e.target.id === 'upgrade-modal') closeUpgradeModal();
  });
  </script>

  <!-- ???????????????????????????????
       HELP / FAQ MODAL
       ??????????????????????????????? -->
  <div id="help-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:480px;">
      <button class="upgrade-close" onclick="closeHelpModal()">&times;</button>
      <div class="upgrade-logo" style="font-size:1.1rem;" data-i18n-text="help_title">Help & FAQ</div>
      <div style="text-align:left;margin-top:16px;font-size:0.8rem;line-height:1.7;color:var(--text-secondary);">

        <details style="margin-bottom:12px;cursor:pointer;">
          <summary style="color:var(--text-primary);font-weight:600;" data-i18n-text="help_faq1_q">&#x1F4B3; I paid but Pro isn't working</summary>
          <p style="margin:6px 0 0 16px;" data-i18n-html="help_faq1_a">It may take up to 1 minute after payment to activate. Try refreshing the page.<br>If it still doesn't work, log out and log back in.<br>If the problem persists, contact us at the email below.</p>
        </details>

        <details style="margin-bottom:12px;cursor:pointer;">
          <summary style="color:var(--text-primary);font-weight:600;" data-i18n-text="help_faq2_q">&#x1F504; How do I cancel or change my card?</summary>
          <p style="margin:6px 0 0 16px;" data-i18n-html="help_faq2_a">Go to Profile menu &rarr; <b>Manage Subscription</b> &rarr; You can change your card, cancel, or view receipts directly in the Stripe portal.<br>If you cancel, you can use Pro until the end of the current billing cycle.</p>
        </details>

        <details style="margin-bottom:12px;cursor:pointer;">
          <summary style="color:var(--text-primary);font-weight:600;" data-i18n-text="help_faq3_q">&#x1F4E1; Data is delayed or blank</summary>
          <p style="margin:6px 0 0 16px;" data-i18n-html="help_faq3_a">This may be due to a temporary outage from external data sources (Binance, CoinGecko, etc.).<br>It usually recovers automatically within a few minutes. Check the connection status indicator at the bottom of the screen.</p>
        </details>

        <details style="margin-bottom:12px;cursor:pointer;">
          <summary style="color:var(--text-primary);font-weight:600;" data-i18n-text="help_faq4_q">&#x1F916; Is AI analysis investment advice?</summary>
          <p style="margin:6px 0 0 16px;" data-i18n-html="help_faq4_a">No. Ryzm's AI analysis is for informational purposes only and is not investment advice.<br>All investment decisions are the user's responsibility.</p>
        </details>

        <details style="margin-bottom:12px;cursor:pointer;">
          <summary style="color:var(--text-primary);font-weight:600;" data-i18n-text="help_faq5_q">&#x1F9E0; How does the Analysis Council work?</summary>
          <p style="margin:6px 0 0 16px;" data-i18n-html="help_faq5_a">A single AI engine analyzes markets through <b>5 specialized frameworks</b> (Macro, On-Chain, Technical, Sentiment, Risk).<br>Each framework focuses on different data and perspectives, producing independent analysis results.<br>Think of it as one analyst running 5 different checklists &mdash; multi-angle analysis in a single pass.</p>
        </details>

        <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-dim);font-size:0.75rem;">
          <b data-i18n-text="help_contact">Contact</b>: <a href="mailto:support@ryzm.io" style="color:var(--neon-gold);text-decoration:none;">support@ryzm.io</a>
        </div>
      </div>
    </div>
  </div>
  <script>
  function openHelpModal() {
    const m = document.getElementById('help-modal');
    if (m) m.style.display = 'flex';
  }
  function closeHelpModal() {
    const m = document.getElementById('help-modal');
    if (m) m.style.display = 'none';
  }
  document.getElementById('help-modal')?.addEventListener('click', e => {
    if (e.target.id === 'help-modal') closeHelpModal();
  });
  </script>

  <!-- ???????????????????????????????
       PRO GATING + ANNOUNCEMENTS
       ??????????????????????????????? -->
  <script>
  /* ── Pro Panel Gating System ── */
  function applyProGating(user) {
    const isPro = user && (user.tier === 'pro' || user.is_admin);
    const panels = document.querySelectorAll('[data-pro="true"]');

    panels.forEach(panel => {
      const existing = panel.querySelector('.pro-lock-overlay');
      if (isPro) {
        // Pro user ? remove locks
        panel.classList.remove('pro-locked');
        if (existing) existing.remove();
      } else {
        // Free user or not logged in ? apply locks
        panel.classList.add('pro-locked');
        if (!existing) {
          const overlay = document.createElement('div');
          overlay.className = 'pro-lock-overlay';
          overlay.innerHTML = `
            <svg class="lock-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" fill="none"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" fill="none"/>
              <circle cx="12" cy="16" r="1" fill="currentColor"/>
            </svg>
            <span class="lock-label">PRO</span>
            <span class="lock-sublabel">Click to upgrade</span>
          `;
          overlay.addEventListener('click', () => {
            if (!_authUser) {
              toggleAuthModal();
            } else {
              openUpgradeModal('panel_locked');
            }
          });
          panel.appendChild(overlay);
        }
      }
    });
  }

  /* ── Announcement Banner System ── */
  let _dismissedAnnouncements = JSON.parse(localStorage.getItem('ryzm_dismissed_ann') || '[]');

  async function loadAnnouncements() {
    try {
      const data = await fetch('/api/announcements').then(r => r.json());
      if (!data || !data.length) return;

      // Remove old banners
      document.querySelectorAll('.announcement-banner').forEach(b => b.remove());

      // Show active announcements not dismissed
      data.filter(a => !_dismissedAnnouncements.includes(a.id)).forEach(ann => {
        const banner = document.createElement('div');
        banner.className = `announcement-banner level-${ann.level || 'info'}`;
        banner.dataset.annId = ann.id;
        banner.innerHTML = `
          <span class="ann-title">${escapeHtml(ann.title)}</span>
          <span class="ann-content">${escapeHtml(ann.content)}</span>
          <button class="ann-close" onclick="dismissAnnouncement(${ann.id}, this)">&times;</button>
        `;
        document.body.prepend(banner);
      });
    } catch { /* silent fail */ }
  }

  function dismissAnnouncement(id, btn) {
    _dismissedAnnouncements.push(id);
    localStorage.setItem('ryzm_dismissed_ann', JSON.stringify(_dismissedAnnouncements));
    const banner = btn.closest('.announcement-banner');
    if (banner) {
      banner.style.animation = 'none';
      banner.style.transform = 'translateY(-100%)';
      banner.style.transition = 'transform 0.3s ease';
      setTimeout(() => banner.remove(), 300);
    }
  }

  // escapeHtml is defined in core.js — do NOT redefine here

  // Add panel_locked to upgrade messages
  if (typeof _upgradeMessages !== 'undefined') {
    _upgradeMessages.panel_locked = 'This panel requires a Pro subscription.';
    _upgradeMessages.csv_export = 'CSV data export is a Pro feature.';
    _upgradeMessages.screenshot = 'Screenshot export is a Pro feature.';
  }

  // Load announcements on page ready
  loadAnnouncements();
  // Refresh announcements every 5 minutes
  setInterval(loadAnnouncements, 300000);

  /* ── Usage Counter ── */
  async function updateUsageCounter() {
    try {
      const data = await fetch('/api/me', { credentials: 'include' }).then(r => r.json());
      const counter = document.getElementById('header-usage-counter');
      if (!counter) return;
      if (data.tier === 'pro' || (_authUser && _authUser.is_admin)) {
        counter.style.display = 'none';
        return;
      }
      // Show for free users (whether logged in or anonymous)
      const council = data.usage?.council || { used: 0, limit: 10 };
      document.getElementById('usage-council').textContent = council.used;
      document.getElementById('usage-council-max').textContent = council.limit;
      // Color coding
      const ratio = council.used / council.limit;
      const valEl = document.getElementById('usage-council');
      if (ratio >= 1) valEl.style.color = 'var(--neon-red, #ef4444)';
      else if (ratio >= 0.7) valEl.style.color = '#eab308';
      else valEl.style.color = 'var(--neon-cyan)';
      counter.style.display = 'inline-flex';
    } catch { /* silent */ }
  }
  updateUsageCounter();
  // Refresh usage every 2 minutes
  setInterval(updateUsageCounter, 120000);

  /* ── Keyboard Shortcuts ── */
  document.addEventListener('keydown', (e) => {
    // Ignore if typing in input/textarea
    if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
    if (e.ctrlKey || e.metaKey) return;
    if (!e.key) return;

    const shortcuts = {
      '1': 'council-section',    // AI Council
      '2': 'prices-section',     // Realtime Prices
      '3': 'scanner-section',    // Alpha Scanner
      '4': 'whale-section',      // Whale Alert
      '5': 'onchain-section',    // On-Chain Radar
      'c': 'council-section',    // Council
      'p': 'prices-section',     // Prices
      'j': null,                 // Journal modal
      '?': null,                 // Help shortcuts
    };

    const key = e.key.toLowerCase();
    if (key === 'j') {
      e.preventDefault();
      if (typeof openJournalModal === 'function') openJournalModal();
      return;
    }
    if (key === '?' || (e.shiftKey && key === '/')) {
      e.preventDefault();
      showKeyboardHelp();
      return;
    }
    if (key === 'escape') {
      // Close any open modal
      document.querySelectorAll('.auth-modal, .upgrade-modal').forEach(m => {
        if (m.style.display !== 'none') m.style.display = 'none';
      });
      return;
    }
    const targetId = shortcuts[key];
    if (targetId) {
      e.preventDefault();
      const el = document.getElementById(targetId);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });

  function showKeyboardHelp() {
    const existing = document.getElementById('kb-help-overlay');
    if (existing) { existing.remove(); return; }
    const overlay = document.createElement('div');
    overlay.id = 'kb-help-overlay';
    overlay.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(3,7,18,0.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
    overlay.innerHTML = `
      <div style="background:var(--bg-panel);border:1px solid var(--border-dim);border-radius:12px;padding:24px 32px;max-width:360px;width:90%;">
        <div style="font-family:var(--font-head);font-size:0.85rem;color:var(--neon-cyan);margin-bottom:16px;text-align:center;">? Keyboard Shortcuts</div>
        <div style="font-size:0.72rem;color:var(--text-secondary);line-height:2;">
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">1</kbd> AI Council</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">2</kbd> Realtime Prices</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">3</kbd> Alpha Scanner</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">4</kbd> Whale Alert</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">5</kbd> On-Chain Radar</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">J</kbd> Signal Journal</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">?</kbd> This help</div>
          <div><kbd style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:3px;font-family:var(--font-mono);margin-right:8px;">Esc</kbd> Close modals</div>
        </div>
        <div style="text-align:center;margin-top:16px;">
          <button onclick="this.closest('#kb-help-overlay').remove()" style="background:var(--neon-cyan);color:#000;border:none;border-radius:6px;padding:6px 20px;font-size:0.72rem;font-weight:600;cursor:pointer;font-family:var(--font-head);">Close</button>
        </div>
      </div>
    `;
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    document.body.appendChild(overlay);
  }

  /* Old onboarding removed — replaced by RyzmOnboarding v2 in portfolio.js */
  </script>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       SIGNAL JOURNAL MODAL
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <div id="journal-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:700px;max-height:85vh;overflow-y:auto;">
      <button class="upgrade-close" onclick="closeJournalModal()">&times;</button>
      <div class="upgrade-logo">?? Signal Journal</div>
      <!-- Journal Stats -->
      <div id="journal-stats" style="display:flex;gap:12px;margin:10px 0;font-size:0.72rem;color:var(--text-secondary);justify-content:center;flex-wrap:wrap;">
        <span>Total: <strong id="j-stat-total">0</strong></span>
        <span style="color:var(--neon-green);">W: <strong id="j-stat-wins">0</strong></span>
        <span style="color:var(--neon-red);">L: <strong id="j-stat-losses">0</strong></span>
        <span>WR: <strong id="j-stat-wr">?</strong></span>
        <span>Open: <strong id="j-stat-open">0</strong></span>
        <button id="btn-export-journal" onclick="exportJournalCSV()" style="font-size:0.62rem;padding:2px 10px;border:1px solid var(--neon-cyan);background:transparent;color:var(--neon-cyan);border-radius:4px;cursor:pointer;margin-left:auto;" title="Export Journal CSV (Pro)">
          ?? Export CSV
        </button>
      </div>
      <!-- Journal Entry List -->
      <div id="journal-entries" style="margin-top:12px;"></div>
      <div id="journal-empty" style="text-align:center;color:var(--text-muted);font-size:0.78rem;padding:30px 0;">
        No journal entries yet. Run an AI Council analysis and click "Save to Journal".
      </div>
    </div>
  </div>

  <!-- Journal Save Form (overlay when saving from council) -->
  <div id="journal-save-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:480px;">
      <button class="upgrade-close" onclick="closeJournalSaveModal()">&times;</button>
      <div class="upgrade-logo">?뱷 Save to Journal</div>
      <form id="journal-save-form" onsubmit="submitJournalEntry(event)" style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
        <div style="display:flex;gap:8px;">
          <select id="j-position" class="val-input" style="flex:1;">
            <option value="">??Position ??</option>
            <option value="LONG">LONG</option>
            <option value="SHORT">SHORT</option>
          </select>
          <input type="number" id="j-entry-price" class="val-input" placeholder="Entry $" step="0.01" min="0" style="flex:1;" />
        </div>
        <div style="display:flex;gap:8px;">
          <input type="number" id="j-stop-loss" class="val-input" placeholder="Stop Loss $" step="0.01" min="0" style="flex:1;" />
          <input type="number" id="j-take-profit" class="val-input" placeholder="Take Profit $" step="0.01" min="0" style="flex:1;" />
        </div>
        <textarea id="j-note" placeholder="Your notes & thesis..." maxlength="2000"
          style="width:100%;height:80px;background:var(--bg-dark);color:var(--text-primary);border:1px solid var(--border-dim);border-radius:4px;padding:8px;font-size:0.78rem;resize:vertical;font-family:inherit;"></textarea>
        <input type="text" id="j-tags" class="val-input" placeholder="Tags (comma-separated)" maxlength="200" />
        <button type="submit" class="auth-submit" style="background:var(--neon-green);color:#000;">
          <i data-lucide="save" style="width:14px;height:14px;"></i> Save Entry
        </button>
        <div id="j-save-error" class="auth-error"></div>
      </form>
    </div>
  </div>

  <!-- Journal Outcome Update Modal -->
  <div id="journal-outcome-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:400px;">
      <button class="upgrade-close" onclick="closeJournalOutcomeModal()">&times;</button>
      <div class="upgrade-logo">?뱤 Record Outcome</div>
      <form id="journal-outcome-form" onsubmit="submitJournalOutcome(event)" style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
        <input type="hidden" id="jo-entry-id" />
        <select id="jo-outcome" class="val-input" required>
          <option value="">??Outcome ??</option>
          <option value="WIN">??WIN</option>
          <option value="LOSS">??LOSS</option>
          <option value="BREAKEVEN">??BREAKEVEN</option>
        </select>
        <input type="number" id="jo-price" class="val-input" placeholder="Exit Price $" step="0.01" min="0" />
        <textarea id="jo-note" placeholder="Outcome notes / lessons learned..." maxlength="2000"
          style="width:100%;height:60px;background:var(--bg-dark);color:var(--text-primary);border:1px solid var(--border-dim);border-radius:4px;padding:8px;font-size:0.78rem;resize:vertical;font-family:inherit;"></textarea>
        <button type="submit" class="auth-submit" style="background:var(--neon-cyan);color:#000;">Record Outcome</button>
      </form>
    </div>
  </div>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       PASSWORD RESET MODAL
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <div id="reset-password-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:400px;">
      <button class="upgrade-close" onclick="closeResetPasswordModal()">&times;</button>
      <div class="upgrade-logo">?뵍 Reset Password</div>
      <form id="reset-pw-form" onsubmit="handleResetPassword(event)" style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
        <input type="hidden" id="reset-token" />
        <input type="password" id="reset-new-pw" placeholder="New Password (8+ chars)" required minlength="8"
          class="val-input" autocomplete="new-password" />
        <input type="password" id="reset-confirm-pw" placeholder="Confirm Password" required minlength="8"
          class="val-input" autocomplete="new-password" />
        <button type="submit" class="auth-submit">Set New Password</button>
        <div id="reset-error" class="auth-error"></div>
        <div id="reset-success" style="color:var(--neon-green);font-size:0.75rem;display:none;"></div>
      </form>
    </div>
  </div>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       TERMS OF SERVICE MODAL
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <div id="tos-modal" class="upgrade-modal" style="display:none;">
    <div class="upgrade-modal-inner" style="max-width:600px;max-height:80vh;overflow-y:auto;">
      <button class="upgrade-close" onclick="closeTosModal()">&times;</button>
      <div class="upgrade-logo">?뱶 Terms of Service</div>
      <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.7;margin-top:12px;text-align:left;">
        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">1. Information Only</h3>
        <p>Ryzm Terminal provides AI-generated market analysis for <strong>informational and educational purposes only</strong>. Nothing on this platform constitutes financial, investment, trading, or any other kind of professional advice.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">2. No Investment Advice</h3>
        <p>All AI council opinions, trade validations, risk scores, and chat responses are generated by machine learning models. They may be <strong>inaccurate, outdated, or misleading</strong>. You should not rely on them to make investment decisions.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">3. Risk Disclosure</h3>
        <p>Cryptocurrency trading involves <strong>substantial risk of loss</strong> and is not suitable for every investor. Past performance, including AI prediction accuracy, is not indicative of future results. You could lose some or all of your capital.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">4. No Liability</h3>
        <p>Ryzm Terminal, its creators, and affiliates shall not be held liable for any losses, damages, or claims arising from your use of this platform or reliance on its AI-generated content.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">5. User Responsibilities</h3>
        <p>You are solely responsible for your trading decisions. Always conduct your own research (DYOR) and consult with a qualified financial advisor before making investment decisions.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">6. Data & Privacy</h3>
        <p>We collect minimal personal data (email, usage analytics). Your journal entries and trading data are stored securely and never shared with third parties. You can request data deletion at any time.</p>

        <h3 style="color:var(--neon-cyan);font-size:0.85rem;">7. Service Changes</h3>
        <p>We reserve the right to modify, suspend, or discontinue the service at any time. Pro subscription terms are governed by our payment processor (Stripe).</p>

        <p style="margin-top:16px;font-style:italic;color:var(--text-muted);">Version 1.0 ??Last updated: 2025</p>
      </div>
      <button onclick="closeTosModal()" class="auth-submit" style="margin-top:12px;">Close</button>
    </div>
  </div>

  <script>
  /* ?? Journal Logic ?? */
  function openJournalModal() {
    document.getElementById('journal-modal').style.display = 'flex';
    loadJournalEntries();
  }
  function closeJournalModal() { document.getElementById('journal-modal').style.display = 'none'; }

  async function exportJournalCSV() {
    try {
      const resp = await fetch('/api/journal/export/csv', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('ryzm_token') },
        credentials: 'include',
      });
      if (resp.status === 403) { openUpgradeModal('csv_export'); return; }
      if (!resp.ok) throw new Error('Export failed');
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ryzm_journal.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('success', '? Exported', 'Journal CSV downloaded.');
    } catch (e) { showToast('error', 'Error', 'CSV export failed.'); }
  }

  function openJournalSaveModal() {
    if (!_authUser) { toggleAuthModal(); return; }
    document.getElementById('journal-save-modal').style.display = 'flex';
    lucide.createIcons();
  }
  function closeJournalSaveModal() { document.getElementById('journal-save-modal').style.display = 'none'; }
  function closeJournalOutcomeModal() { document.getElementById('journal-outcome-modal').style.display = 'none'; }

  // Save to Journal button
  document.getElementById('btn-save-journal')?.addEventListener('click', () => {
    playSound('click');
    openJournalSaveModal();
  });

  async function submitJournalEntry(e) {
    e.preventDefault();
    const errEl = document.getElementById('j-save-error');
    errEl.textContent = '';
    const data = window._lastCouncilData || {};
    try {
      const result = await apiFetch('/api/journal', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          council_id: 0,
          snapshot: data,
          position_type: document.getElementById('j-position').value,
          entry_price: parseFloat(document.getElementById('j-entry-price').value) || 0,
          stop_loss: parseFloat(document.getElementById('j-stop-loss').value) || 0,
          take_profit: parseFloat(document.getElementById('j-take-profit').value) || 0,
          user_note: document.getElementById('j-note').value,
          tags: document.getElementById('j-tags').value,
        }),
      });
      showToast('success', '?뱮 Saved', 'Entry saved to Signal Journal.');
      closeJournalSaveModal();
      document.getElementById('journal-save-form').reset();
    } catch (e) {
      errEl.textContent = e.data?.detail || 'Connection error';
    }
  }

  async function loadJournalEntries() {
    try {
      const data = await apiFetch('/api/journal?limit=50', { silent: true });
      const container = document.getElementById('journal-entries');
      const empty = document.getElementById('journal-empty');
      // Stats
      const s = data.stats || {};
      document.getElementById('j-stat-total').textContent = s.total || 0;
      document.getElementById('j-stat-wins').textContent = s.wins || 0;
      document.getElementById('j-stat-losses').textContent = s.losses || 0;
      document.getElementById('j-stat-wr').textContent = s.win_rate != null ? s.win_rate + '%' : '--';
      document.getElementById('j-stat-open').textContent = s.open || 0;

      if (!data.entries || data.entries.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      container.innerHTML = data.entries.map(e => {
        const snap = e.snapshot || {};
        const vibe = snap.vibe?.status || '--';
        const score = snap.consensus_score ?? '--';
        const pred = snap.prediction || '--';
        const outcomeColor = e.outcome === 'WIN' ? 'var(--neon-green)' : e.outcome === 'LOSS' ? 'var(--neon-red)' : 'var(--text-muted)';
        const outcomeLabel = e.outcome || 'OPEN';
        const posLabel = e.position_type ? `${e.position_type} @ $${e.entry_price.toLocaleString()}` : '';
        const slTp = (e.stop_loss || e.take_profit) ? `SL: $${(e.stop_loss||0).toLocaleString()} / TP: $${(e.take_profit||0).toLocaleString()}` : '';
        return `
          <div class="journal-entry" style="background:var(--bg-panel);border:1px solid var(--border-dim);border-radius:6px;padding:12px;margin-bottom:8px;font-size:0.75rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="color:var(--text-muted);">${escapeHtml(e.created_at_utc || '')}</span>
              <span style="color:${outcomeColor};font-weight:700;font-size:0.8rem;">${escapeHtml(outcomeLabel)}</span>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:4px;">
              <span style="color:var(--neon-cyan);">Score: ${escapeHtml(String(score))}</span>
              <span>Pred: ${escapeHtml(pred)}</span>
              <span>Vibe: ${escapeHtml(vibe)}</span>
              ${posLabel ? `<span style="color:var(--neon-magenta);">${escapeHtml(posLabel)}</span>` : ''}
            </div>
            ${slTp ? `<div style="color:var(--text-muted);font-size:0.7rem;">${escapeHtml(slTp)}</div>` : ''}
            ${e.user_note ? `<div style="margin-top:4px;color:var(--text-secondary);font-style:italic;">"${escapeHtml(e.user_note)}"</div>` : ''}
            ${e.tags ? `<div style="margin-top:4px;">${e.tags.split(',').map(t => `<span style="background:rgba(201,169,110,0.15);color:var(--neon-cyan);padding:1px 6px;border-radius:3px;font-size:0.65rem;margin-right:4px;">${escapeHtml(t.trim())}</span>`).join('')}</div>` : ''}
            <div style="margin-top:6px;display:flex;gap:6px;">
              ${!e.outcome ? `<button onclick="openOutcomeModal(${e.id})" style="background:var(--neon-cyan);color:#000;border:none;padding:3px 10px;border-radius:3px;font-size:0.68rem;cursor:pointer;">Record Outcome</button>` : ''}
              ${e.outcome_note ? `<span style="color:var(--text-muted);font-size:0.68rem;">?뱷 ${escapeHtml(e.outcome_note)}</span>` : ''}
              <button onclick="deleteJournalEntry(${e.id})" style="background:transparent;color:var(--neon-red);border:1px solid rgba(244,63,94,0.3);padding:3px 8px;border-radius:3px;font-size:0.65rem;cursor:pointer;margin-left:auto;">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    } catch { /* silent */ }
  }

  function openOutcomeModal(entryId) {
    document.getElementById('jo-entry-id').value = entryId;
    document.getElementById('journal-outcome-modal').style.display = 'flex';
  }

  async function submitJournalOutcome(e) {
    e.preventDefault();
    const entryId = document.getElementById('jo-entry-id').value;
    try {
      await apiFetch(`/api/journal/${entryId}`, {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          outcome: document.getElementById('jo-outcome').value,
          outcome_price: parseFloat(document.getElementById('jo-price').value) || 0,
          outcome_note: document.getElementById('jo-note').value,
        }),
      });
      showToast('success', '?뱤 Updated', 'Outcome recorded.');
      closeJournalOutcomeModal();
      document.getElementById('journal-outcome-form').reset();
      loadJournalEntries();
    } catch { showToast('error', 'Error', 'Connection error.'); }
  }

  async function deleteJournalEntry(entryId) {
    if (!confirm('Delete this journal entry?')) return;
    try {
      await apiFetch(`/api/journal/${entryId}`, { method: 'DELETE', silent: true });
      showToast('info', 'Deleted', 'Entry removed.'); loadJournalEntries();
    } catch { /* silent */ }
  }

  /* ?? Reset Password Modal ?? */
  function openResetPasswordModal(token) {
    document.getElementById('reset-token').value = token;
    document.getElementById('reset-password-modal').style.display = 'flex';
  }
  function closeResetPasswordModal() { document.getElementById('reset-password-modal').style.display = 'none'; }
  async function handleResetPassword(e) {
    e.preventDefault();
    const errEl = document.getElementById('reset-error');
    const sucEl = document.getElementById('reset-success');
    errEl.textContent = ''; sucEl.style.display = 'none';
    const pw = document.getElementById('reset-new-pw').value;
    const confirm = document.getElementById('reset-confirm-pw').value;
    if (pw !== confirm) { errEl.textContent = 'Passwords do not match.'; return; }
    try {
      const data = await apiFetch('/api/auth/reset-password', {
        method: 'POST', headers: {'Content-Type':'application/json'}, silent: true,
        body: JSON.stringify({ token: document.getElementById('reset-token').value, new_password: pw }),
      });
      sucEl.textContent = data.message || 'Password reset! You can now login.';
      sucEl.style.display = 'block';
      setTimeout(() => { closeResetPasswordModal(); toggleAuthModal(); }, 2000);
    } catch (e) { errEl.textContent = e.data?.detail || 'Connection error.'; }
  }

  /* ?? ToS Modal ?? */
  function openTosModal(e) { if (e) e.preventDefault(); document.getElementById('tos-modal').style.display = 'flex'; }
  function closeTosModal() { document.getElementById('tos-modal').style.display = 'none'; }

  /* ?? Modal backdrop close ?? */
  ['journal-modal','journal-save-modal','journal-outcome-modal','reset-password-modal','tos-modal','daily-report-modal'].forEach(id => {
    document.getElementById(id)?.addEventListener('click', e => {
      if (e.target.id === id) e.target.style.display = 'none';
    });
  });
  </script>

  <!-- Daily Report Modal -->
  <div id="daily-report-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;">
    <div style="background:var(--bg-panel);border:1px solid var(--border-bright);border-radius:var(--radius-md);padding:28px 24px;max-width:400px;width:90%;position:relative;">
      <button onclick="closeDailyReportModal()" style="position:absolute;top:10px;right:14px;background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;">&times;</button>
      <h3 style="font-family:var(--font-head);font-size:0.95rem;color:var(--neon-gold);margin-bottom:4px;" data-i18n-text="dr_title">Daily Market Briefing</h3>
      <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:20px;" data-i18n-text="dr_desc">Get a daily market analysis report every morning at 9 AM (KST).</p>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:rgba(88,101,242,0.06);border:1px solid rgba(88,101,242,0.15);border-radius:8px;color:rgba(114,137,218,0.5);font-size:0.82rem;font-weight:600;cursor:default;">
          <svg width="20" height="20" viewBox="0 0 71 55" fill="currentColor"><path d="M60.1 4.9A58.5 58.5 0 0045.4.2a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.5 37.5 0 0025.4.3a.2.2 0 00-.2-.1 58.4 58.4 0 00-14.7 4.6.2.2 0 00-.1.1C1.5 18.7-.9 32 .3 45.1v.2a58.9 58.9 0 0017.8 9 .2.2 0 00.3-.1 42 42 0 003.6-5.9.2.2 0 00-.1-.3 38.8 38.8 0 01-5.6-2.7.2.2 0 01 0-.4c.4-.3.8-.6 1.1-.9a.2.2 0 01.2 0c11.8 5.4 24.5 5.4 36.2 0a.2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.4 36.4 0 01-5.6 2.6.2.2 0 00-.1.3 47.2 47.2 0 003.6 6 .2.2 0 00.3 0A58.7 58.7 0 0070.7 45.3v-.1C72 30.1 68 16.9 60.2 5a.2.2 0 00-.1 0zM23.7 37c-3.5 0-6.3-3.2-6.3-7.1s2.8-7.1 6.3-7.1 6.4 3.2 6.3 7.1c0 3.9-2.8 7.1-6.3 7.1zm23.3 0c-3.5 0-6.3-3.2-6.3-7.1s2.8-7.1 6.3-7.1 6.4 3.2 6.3 7.1c0 3.9-2.8 7.1-6.3 7.1z"/></svg>
          Discord — Coming Soon
        </div>
        <div style="text-align:center;font-size:0.7rem;color:var(--text-muted);" data-i18n-text="dr_or">or</div>
        <div style="display:flex;gap:8px;">
          <input type="email" id="daily-report-email" data-i18n-placeholder="dr_placeholder" placeholder="Enter email address"
                 style="flex:1;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border-dim);border-radius:6px;color:var(--text-main);font-size:0.8rem;outline:none;" />
          <button onclick="subscribeDailyReport()" data-i18n-text="dr_subscribe" style="padding:10px 16px;background:var(--neon-gold);color:#0D0D0F;border:none;border-radius:6px;font-family:var(--font-head);font-size:0.7rem;font-weight:600;cursor:pointer;white-space:nowrap;">Subscribe</button>
        </div>
        <p id="daily-report-msg" style="font-size:0.7rem;color:var(--neon-green);display:none;text-align:center;margin-top:4px;"></p>
      </div>
    </div>
  </div>

  <script>
  function openDailyReportModal() { document.getElementById('daily-report-modal').style.display = 'flex'; }
  function closeDailyReportModal() { document.getElementById('daily-report-modal').style.display = 'none'; }
  function subscribeDailyReport() {
    const email = document.getElementById('daily-report-email').value.trim();
    if (!email || !email.includes('@')) {
      const msg = document.getElementById('daily-report-msg');
      msg.style.color = 'var(--neon-red)';
      msg.textContent = typeof t === 'function' ? t('dr_email_error') : 'Please enter a valid email address.';
      msg.style.display = 'block';
      return;
    }
    fetch('/api/subscribe-briefing', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email}) })
      .then(r => r.json())
      .then(d => {
        const msg = document.getElementById('daily-report-msg');
        msg.style.color = d.status === 'error' ? 'var(--neon-red)' : 'var(--neon-green)';
        msg.textContent = d.message || 'Subscribed!';
        msg.style.display = 'block';
      })
      .catch(() => {
        const msg = document.getElementById('daily-report-msg');
        msg.style.color = 'var(--neon-red)';
        msg.textContent = 'Network error. Please try again.';
        msg.style.display = 'block';
      });
  }
  </script>

  <!-- ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??
       DISCLAIMER FOOTER
       ?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧?먥븧??-->
  <div class="disclaimer-bar" style="position:fixed;bottom:0;left:0;right:0;z-index:999;background:rgba(10,10,15,0.95);border-top:1px solid rgba(244,63,94,0.3);padding:4px 16px;font-size:0.6rem;color:var(--text-muted);text-align:center;pointer-events:none;">
    ?좑툘 Ryzm Terminal provides AI-generated analysis for informational purposes only. Not financial advice. Trading crypto involves substantial risk of loss. DYOR.
  </div>

  <script>
    // Remove boot overlay after animation
    (function() {
      var boot = document.getElementById('dash-boot');
      if (boot) setTimeout(function() { boot.remove(); }, 1800);
    })();
  </script>
</body>

</html>
